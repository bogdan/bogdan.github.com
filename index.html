<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

    <title>
      
      Bogdan's blog
    </title>
    <meta name="robots" content="follow, all" />
    <meta charset="utf-8"> 
    
    <meta name="description" content="This is personal blog of Bogdan Gusiev: ruby on rails developer, open source contributor">
    <meta name="keywords" content="activerecord, ajax, api, application, bdd, behavior, changelog, class, commit, context, contribution, criticism, database, datagrid, debug, dry, gem, git, howto, html, idea, java, javascript, jquery, patch, pattern, performance, programming, query, rails, report, resque, rspec, ruby, service, slides, sql, test, usability, validation, vim" />
    <link rel="stylesheet" href="/css/default.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/highlight.css" type="text/css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Bogdan Gusiev's blog RSS Feed" href="http://feeds.feedburner.com/BogdanGusiev" />
    <link rel="shortcut icon" href="/images/favicon.ico"/>
    <link rel="icon" href="/images/favicon.ico"/>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                var params = decodeURI(window.location.search).replace(/^\?/, "").split("&");
                $(params).each(function(index, param) {
                    if (param.match(/^p=/)) {

                        switch(parseInt(param.split("=")[1])) {
                            case 11: window.location.href = "http://www.gusiev.com/2009/04/clear-upload-file-input-field/";
                            break;
                            case 3: window.location.href = "http://www.gusiev.com/2009/04/upload-files-with-selenium-ide/";
                            break;
                        }
                    }
                })
            });
        </script>
    </head>

    <body>
      <div id="fb-root"></div>
      <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=354906294546402";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));</script>
        <a href="http://github.com/bogdan" class="fork">
            <img src="/images/fork.png"/>
        </a>

        <div id="wrapper">

            <div class="header">
                <div class="title">
                    <h1><a href="/">Bogdan Gusiev's blog</a></h1>
                    <h4>How to make good software <a class="for-people" href="/pages/about.html#dream_job">for people</a></h4>
                </div>

                <div class="pages">
                    <a href="/">Home</a>
                    <a href="/pages/about.html">About me</a>
                    <a href="/pages/contacts.html">Contacts</a>
                </div>
                <a href="/pages/about.html" class="avatar">
                    <img src="/images/me.jpg"/>
                </a>
                <div class="clear"></div>
                <hr/>
            </div> <!-- Closes header -->


            <div id="main">

                <div id="content">
                    
    <div class="post">
        <h2>
            <a href='/2014/04/state-machine-minemalistic-validation-perfection-changes'>Minimalistic State Machine: Less is More</a>
            <div class="date">01 Apr 2014</div>
        </h2>
        
<p>I have tried a bunch of ActiveRecord’s state machine gems. Their functionality is very close to each other. It allows to validate a state transition and reinvent ruby programming language to define transition methods. The fact that all of them produces custom API to define a ruby method doesn’t look right… <!--</p>

<h3 id="samples_using_common_state_machine_gems">Samples using common state machine gems</h3>
<div class='highlight'><pre><code class='ruby'><span class='c1'># State Machine gem example</span>
<span class='n'>state_machine</span> <span class='ss'>:state</span><span class='p'>,</span> <span class='ss'>:initial</span> <span class='o'>=&gt;</span> <span class='ss'>:parked</span> <span class='k'>do</span>
  <span class='n'>event</span> <span class='ss'>:approve!</span> <span class='k'>do</span>
    <span class='n'>transition</span> <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='ss'>:approved</span>
  <span class='k'>end</span>
  <span class='n'>after_transition</span> <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:do</span> <span class='o'>=&gt;</span> <span class='ss'>:send_approval_email</span>
<span class='k'>end</span>

<span class='c1'># Workflow gem example</span>
<span class='n'>workflow</span> <span class='k'>do</span>
  <span class='n'>state</span> <span class='ss'>:pending</span> <span class='k'>do</span>
    <span class='n'>event</span> <span class='ss'>:approve!</span><span class='p'>,</span> <span class='ss'>:transitions_to</span> <span class='o'>=&gt;</span> <span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:after_transition</span> <span class='o'>=&gt;</span> <span class='ss'>:send_approval_email</span>
  <span class='k'>end</span>
<span class='k'>end</span>

<span class='c1'># And finally plain ruby/rails example</span>
<span class='k'>def</span> <span class='nf'>approve!</span>
  <span class='n'>update_attributes!</span><span class='p'>(</span><span class='ss'>:state</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;approved&quot;</span><span class='p'>)</span>
  <span class='n'>send_approval_email</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Maybe I don’t know all modern trends but ruby version looks more human readable to me.</p>

<h3 id="so_why_do_we_still_tend_to_use_state_machine_gems">So why do we still tend to use state machine gems</h3>

<p>The main reason is state change validation. It won’t be easy to always check if it is possible to transition object from state A to state B in plain Ruby. This part of state machine is something that really matter.</p>

<p>In my head it appears as some kind of allowed changes map:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>order_state_changes_map</span> <span class='o'>=</span> <span class='p'>{</span> 
  <span class='kp'>nil</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:pending</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Initial state is always pending</span>
  <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:rejected</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Pending can be changed to to paid and delivered</span>
  <span class='ss'>:approved</span> <span class='o'>=&gt;</span> <span class='ss'>:paid</span> <span class='c1'># Delivered can only be changed to paid</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>If the state machine’s main goal is to validate changes than let’s implement it as a validation:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>Order</span> <span class='o'>&lt;</span> <span class='no'>AR</span><span class='o'>::</span><span class='no'>Base</span>
  <span class='n'>validates</span> <span class='ss'>:state</span><span class='p'>,</span> <span class='ss'>:changes</span> <span class='o'>=&gt;</span> <span class='n'>order_state_changes_map</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>With this pattern you can define state change methods in ruby:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>validates</span> <span class='ss'>:state</span><span class='p'>,</span> <span class='ss'>:changes</span> <span class='o'>=&gt;</span> <span class='p'>{</span> 
  <span class='kp'>nil</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:pending</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Initial state is always pending</span>
  <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:rejected</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Pending can be changed to to paid and delivered</span>
  <span class='ss'>:approved</span> <span class='o'>=&gt;</span> <span class='ss'>:paid</span> <span class='c1'># Delivered can only be changed to paid</span>
<span class='p'>}</span>

<span class='k'>def</span> <span class='nf'>upproved!</span>
  <span class='c1'># ....</span>
<span class='k'>end</span>

<span class='k'>def</span> <span class='nf'>upproved?</span>
  <span class='c1'># ....</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Now it looks really readable and a person who never saw this kind of API before can figure out what is happening.</p>

<p>Give a try to: <a href="https://github.com/bogdan/changes_validator">ChangesValidator</a> in your app</p>
-->
        <h4 class="tags">
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/validation.html">validation</a>
    
    <a href="/tags/statemachine.html">statemachine</a>
    
    <a href="/tags/criticism.html">criticism</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2013/11/datagrid-slides-report-framework'>Datagrid slides from Ruby Meditation 3</a>
            <div class="date">04 Nov 2013</div>
        </h2>
        
<p>Here are my <a href="http://gusiev.com/slides/datagrid/index.html#/">slides about Datagrid gem</a> from Ruby Meditation Conference last weekend. Datagrid is a gem I’ve released almost 3 years ago. It is focused on table data representation and now allowes a full power flexibility to be called a Framework.</p>

<p><a href="http://github.com/bogdan/datagrid">http://github.com/bogdan/datagrid</a></p>
<!---->
        <h4 class="tags">
    
    <a href="/tags/slides.html">slides</a>
    
    <a href="/tags/datagrid.html">datagrid</a>
    
    <a href="/tags/gem.html">gem</a>
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/activerecord.html">activerecord</a>
    
    <a href="/tags/report.html">report</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2013/05/rails-ajax-validation-form-submit-javascript'>Support validation through ajax in Rails 4.x</a>
            <div class="date">24 May 2013</div>
        </h2>
        
<p>I have a constant feeling that in a modern web every web form should be submitted with AJAX not the old retro way with POST request. This is better for numerous reasons.</p>

<p>At first, it gives better user experience At second, AJAX is faster than regular request. At the end, it doesn’t require a work to redraw the page with it’s previous state if validation fails.</p>

<p>Currently I am trying to make rails app support this out of the box. And here is first small step to this goal:</p>

<p><a href="https://github.com/rails/rails/pull/8638">This patch</a> allows a complete validation though ajax using active model validators. This is a <a href="http://rails-ajax-validation.herokuapp.com/developers/new">live demo</a> of what it allows to do. If you feel especially interested in this feature, say your +1 here or on github.</p>
<!---->
        <h4 class="tags">
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/contribution.html">contribution</a>
    
    <a href="/tags/javascript.html">javascript</a>
    
    <a href="/tags/ajax.html">ajax</a>
    
    <a href="/tags/validation.html">validation</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2013/04/git-story-id-pivotal-tracker-integration'>Attach git commits to pivotal stories</a>
            <div class="date">08 Apr 2013</div>
        </h2>
        
<p>I heard about 10 different ways to organize work flow around pivotaltracker and git and about 5 gems to support that process. All of them seems abusing for me: the outcome of pivotal/git integration is a git commit attached to pivotal story and the rest of conventions like naming branches or merge policy doesn’t make any sense in long time perspective and is just a waste of time in fact.</p>

<p>That’s why I’ve decided to make the most trivial integration that covers this idea and don’t provide additional complexity: Meet <a href="https://github.com/bogdan/git-storyid">git-storyid</a> gem - the only one git/pivotaltracker integration that saves your time. <!--</p>

<h2 id="installation">Installation</h2>
<div class='highlight'><pre><code class='sh'>gem install git-storyid
</code></pre>
</div>
<h2 id="usage">Usage</h2>
<div class='highlight'><pre><code class='sh'>git storyid -m <span class='s2'>&quot;Initial implementation of campaign tags&quot;</span>
<span class='c'># Api token (https://www.pivotaltracker.com/profile): a56f0e9a4fbXXXXXXXXXXXXXX</span>
<span class='c'># Use SSL (y/n): y</span>
<span class='c'># Your pivotal initials (e.g. BG): BG</span>
<span class='c'># Project ID: 494XXX</span>
</code></pre>
</div>
<p>Now interactive menu is displayed to select one of <strong>Started stories</strong> owned by you:</p>
<pre><code>[1] Removing Billing Page
[2] Welcome Email
[3] Email Shares -  Capture
[4] Speed up activities by dates aggregation
[5] Mass Email to Customer List - thurs AM
[6] Investigate production error
[7] Tag campaign insertion points

Indexes(csv): 7
[campaign-tags 3020407]  [#44116647] Initial implementation of campaign tags
 1 file changed, 1 insertion(+), 2 deletions(-)</code></pre>
<p>Result commit:</p>
<pre><code>commit 3020407e92cb125083cf50ad494ff15169a7f2e6
Author: Bogdan Gusiev &lt;youremail@gmail.com&gt;
Date:   Fri Mar 15 12:42:32 2013 +0200

[#44116647] Initial implementation of campaign tags

Feature: Tag campaign insertion points and 
campaigns with an identifier, 
so only campaigns with matching identifier will get shown</code></pre>
<h2 id="how_should_i_name_branches">How should I name branches?</h2>

<p>Branch names is not something that you should focus on. Unlike commit messages, branches are removed from history after merge. That is why you should name them in a way that takes less of your time. I personally prefer to have only one branch for myself called <code>bogdandev</code> when I work on a project. When the feature is not done - there is no sense to work on another feature.</p>
-->
        <h4 class="tags">
    
    <a href="/tags/git.html">git</a>
    
    <a href="/tags/commit.html">commit</a>
    
    <a href="/tags/gem.html">gem</a>
    
    <a href="/tags/pivotaltracker.html">pivotaltracker</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2013/04/background-jobs-frameworkds-delayed-job-resque-slides'>Background Jobs Frameworks: Resque vs DelayedJob</a>
            <div class="date">08 Apr 2013</div>
        </h2>
        
<p>Here are my slides from Ruby Meditation meet-up in Kiev last weekend. Covers some internals and some features of DelayedJob and Resque. <a href="http://x.gusiev.com/background-jobs-frameworks">http://x.gusiev.com/background-jobs-frameworks</a> <!--</p>
-->
        <h4 class="tags">
    
    <a href="/tags/resque.html">resque</a>
    
    <a href="/tags/delayedjob.html">delayedjob</a>
    
    <a href="/tags/slides.html">slides</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2013/02/working-in-curebit-ycombinator-ukraine-job'>Where to work as a rubyist in Ukraine</a>
            <div class="date">15 Feb 2013</div>
        </h2>
        
<p>Allan was the first business guy in my life that was more focused on building product than raising money — build features endless cycle. So we started to work together.</p>
<!--
<p><img src='https://d2vzmlm7xciaqk.cloudfront.net/asset-vb3f26d3/images/curebit-logo-transparent.png' style='margin: 5px auto; display: block;height: 50px' /></p>

<p>Curebit is a San Francisco-based startup that recently opened an office in Kiev, and I’d like to invite you to interview with us.</p>

<p>Allan is also a Rails developer (<a href="http://github.com/allangrant">http://github.com/allangrant</a>) of Ukrainian origin. Our company, Curebit, raised <a href="http://www.crunchbase.com/company/curebit">$1.2 million</a> from great investors like YCombinator (the creators of Hacker News) and 500Startups. The company is small (10 people) but profitable, and growing. We are a product company working on interesting architectural challenges and we are making the best product in our market (referral systems for e-commerce companies). We are now moving fast from being a good product to being a good platform. This fact give us really advanced challenges to fight with.</p>

<p>The team in Ukraine is only 6 people right now, but everyone is AMAZING and we want to get the best developers on-board. I am leading the engineering team, and Sergii Iurevych (OOCSS expert) leads design &amp; front-end development. We pay everyone generously a San Francisco level salary because we know that our country has engineers that are worth it.</p>

<p>Most importantly (this is hard to explain in blog post), we have unique values that make Curebit a great place to work. We prefer to cut features/move deadlines instead of giving up code quality/polish. We don’t keep track of vacation days, because everyone we work with loves their work. We’re building a company to create value in the world, not just for profit. We have a culture, and we don’t write it down or talk about — we just live it.</p>

<p>We would love to meet you, even if you are not looking for a job right now. Please shoot us email to <a href="mailto:bogdan@curebit.com">bogdan@curebit.com</a></p>

<p>If you want to see our product, check out the site at <a href="http://curebit.com">http://curebit.com</a> (feel free to create fake account), or play with this demo account: <a href="http://curebit.com/demo">http://curebit.com/demo</a> (it’s an old demo that doesn’t show much).</p>
-->
        <h4 class="tags">
    
    <a href="/tags/job.html">job</a>
    
    <a href="/tags/work.html">work</a>
    
    <a href="/tags/ycombinator.html">ycombinator</a>
    
    <a href="/tags/silicon valley.html">silicon valley</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2012/12/rails-contribution-slides-from-ruby-meetup'>Rails Contribution slides from ruby meetup in Kiev</a>
            <div class="date">11 Dec 2012</div>
        </h2>
        
<p>Here are slides I’ve shown on ruby meetup in Kiev. It’s all about my expirience with <a href="http://gusiev.com/slides/rails_contribution/static/#1">power hacking rails internals</a>. Give some inside on how ActiveSupport Callbacks and Rails Router are working.</p>
<!---->
        <h4 class="tags">
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/contribution.html">contribution</a>
    
    <a href="/tags/slides.html">slides</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2012/10/crazy-javascript-initialization-strategy'>Smart Javascript Initialization Strategy</a>
            <div class="date">08 Oct 2012</div>
        </h2>
        
<p>JavaScript initialization process is a pain in the ass since dynamic HTML and AJAX became popular. We need to take care all the time about what we need to initialize after every change in DOM. Thanks to <code>jQuery#live</code> and <code>jQuery#on</code> that is not so right but still very effective solution. It allows to fix the problem with initialization of typical events. But initialization is not always about binding DOM events. In more advanced cases it could be wrapping widget class over an element or custom jQuery method call like date-picker.</p>
<!--
<p>Here is an example:</p>
<div class='highlight'><pre><code class='js'><span class='c1'>// This line will be required not only on `$(docuemnt).ready` </span>
<span class='c1'>// but every time an update in DOM occur that adds some new date input on page.</span>
<span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;.data-picker&quot;</span><span class='p'>).</span><span class='nx'>datePicker</span><span class='p'>();</span>
</code></pre>
</div>
<p>Or advanced example:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>ImageGallery</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(){</span>
  <span class='cm'>/* Class with 100+ lines of code here */</span>
<span class='p'>};</span> 
<span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;.image-gallery&quot;</span><span class='p'>).</span><span class='nx'>each</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>element</span><span class='p'>){</span>
  <span class='k'>new</span> <span class='nx'>ImageGallery</span><span class='p'>(</span><span class='nx'>element</span><span class='p'>);</span>
<span class='p'>});</span>
</code></pre>
</div>
<p>In example above is split into two sections: definition and initialization. This fact makes code hard to follow as moving from class to DOM element in HTML template require at least two transitions in your editor.</p>

<p>And when large page update comes after ajax query this is getting even worth. All initializer should called again:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>$</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='s2'>&quot;/profile/edit&quot;</span><span class='p'>,</span> <span class='nx'>data</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>response</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='nx'>showSomeProfileEditingPopup</span><span class='p'>(</span><span class='nx'>response</span><span class='p'>);</span>
  <span class='nx'>$</span><span class='p'>(</span><span class='s2'>&quot;.profile-birth-date&quot;</span><span class='p'>).</span><span class='nx'>datePicker</span><span class='p'>();</span>
  <span class='k'>new</span> <span class='nx'>ImageGallery</span><span class='p'>(</span><span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;.profile-image-gallery&#39;</span><span class='p'>));</span>
  <span class='c1'>// More initialization here</span>
<span class='p'>});</span>
</code></pre>
</div>
<h3 id="tired_to_handle_things_like_this">Tired to handle things like this?</h3>

<h2 id="change_the_way_of_thinking_about_initialization">Change the way of thinking about initialization</h2>

<p>Initialization code is a bridge where between actual JS class and DOM element. In 99% of cases it has one to one or one to many relation. Than, why do we always need that intermediate initialization code?</p>

<p>The DOM element could have the class itself:</p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;div</span> <span class='na'>class=</span><span class='s'>&quot;profile-image-gallery&quot;</span> <span class='na'>data-class=</span><span class='s'>&quot;ImageGallery&quot;</span><span class='nt'>&gt;</span>
</code></pre>
</div>
<p>Now your way from DOM element to JS class require only one transition. Moreover all DOM elements could be initialized with one call. It needs to run over DOM and find all elements with <code>data-class</code> attributes that are not initialized and wrap them with a specified class:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>Initializer</span> <span class='o'>=</span> <span class='p'>{</span>
  <span class='nx'>perform</span><span class='o'>:</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='nx'>$</span><span class='p'>(</span><span class='s1'>&#39;[data-class]:not(.initialized)&#39;</span><span class='p'>).</span><span class='nx'>each</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>,</span> <span class='nx'>element</span><span class='p'>)</span> <span class='p'>{</span>
      <span class='kd'>var</span> <span class='nx'>element</span> <span class='o'>=</span> <span class='nx'>$</span><span class='p'>(</span><span class='nx'>element</span><span class='p'>);</span>
      <span class='nx'>element</span><span class='p'>.</span><span class='nx'>addClass</span><span class='p'>(</span><span class='s1'>&#39;initialized&#39;</span><span class='p'>);</span>
      <span class='kd'>var</span> <span class='nx'>klass</span> <span class='o'>=</span> <span class='nb'>window</span><span class='p'>[</span><span class='nx'>element</span><span class='p'>.</span><span class='nx'>data</span><span class='p'>(</span><span class='nx'>element</span><span class='p'>)];</span>
      <span class='k'>new</span> <span class='nx'>klass</span><span class='p'>(</span><span class='nx'>element</span><span class='p'>);</span>
    <span class='p'>});</span>
  <span class='p'>}</span>
<span class='p'>};</span>
</code></pre>
</div>
<p>This code bit will probably require some additional functionality to support an options but general idea is strong enough to handle all possible complexity in a future. Now, whenever DOM changes everything we need to do is call:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>Initializer</span><span class='p'>.</span><span class='nx'>perform</span><span class='p'>();</span>
</code></pre>
</div>
<p>In order to attach third-party libraries to this initialization process we need to create a simple wrapping class around them:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>DatePicker</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>(</span><span class='nx'>element</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='nx'>$</span><span class='p'>(</span><span class='nx'>element</span><span class='p'>).</span><span class='nx'>datePicker</span><span class='p'>()</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Now we are able to convert inputs to date pickers with unified initialization process:</p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;profile[birth_date]&quot;</span> <span class='na'>data-class=</span><span class='s'>&quot;DatePicker&quot;</span><span class='nt'>&gt;</span>
</code></pre>
</div>
<h2 id="conclusion">Conclusion</h2>

<p>JavaScript coding is annoying for most people that came from other languages because it keeps fragmented things that should be bound together. In order to avoid this problem we need to invent conventions to follow, so that every person in a team understand that. But the cost of convention described here is not that much and makes code move clean and easy to follow.</p>
-->
        <h4 class="tags">
    
    <a href="/tags/javascript.html">javascript</a>
    
    <a href="/tags/initialization.html">initialization</a>
    
    <a href="/tags/class.html">class</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2012/09/rails-strict-validation-popularity'>Strict validation is a main stream</a>
            <div class="date">17 Sep 2012</div>
        </h2>
        
<p>It’s nice to see that <a href="/2012/01/rails-32-features-changelog/#strict_validation_concept">strict validation feature</a> that I’ve <a href="https://github.com/rails/rails/commit/8620bf90c5e486e1ec44b9aabb63f8c848668ed2">done almost a year ago</a> is <a href="http://robots.thoughtbot.com/post/31728620503/refactoring-replace-conditional-with-polymorphism">finally getting popular</a>. Spend a moment and understand what it does by <a href="http://api.rubyonrails.org/classes/ActiveModel/Validations/ClassMethods.html#method-i-validates-21">Rails documentation</a>.</p>
<!---->
        <h4 class="tags">
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/contribution.html">contribution</a>
    
    <a href="/tags/validation.html">validation</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2012/08/postgresql-full-text-search-solr'>Full text search - Solr(Sunspot) vs PostgreSQL</a>
            <div class="date">16 Aug 2012</div>
        </h2>
        
<p>This is short notes about my experience with full text search based on PostgreSQL and Solr. Solr was primary used with a help of <a href="https://github.com/sunspot/sunspot">Sunspot gem</a> that was definitely a good idea, but unfortunately caused some drawbacks. PostgreSQL provides full text search out of the box and to my opinion doesn’t need any additional ruby specific tools other than ORM. <!--</p>

<h2 id="tldr">TL;DR</h2>

<p>PostgreSQL approach is simple and fit well to agile project. Solr is pretty powerful, but you need to pay for that power. And this is significant cost. Think twice if you really need this power from the first day of full text search in your project.</p>

<h2 id="search_index">Search index</h2>

<p>Solr search index is something you create almost manually by defining a new data schema. Sunspot sets <code>after_save</code> hooks to your model to update it’s solr index.</p>

<p>Here is an example of schema definition based on Sunspot gem:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>Product</span> <span class='o'>&lt;</span> <span class='no'>ActiveRecord</span><span class='o'>::</span><span class='no'>Base</span>
  <span class='n'>searchable</span> <span class='k'>do</span>
    <span class='n'>text</span> <span class='ss'>:title</span>
    <span class='n'>text</span> <span class='ss'>:material</span>
    <span class='n'>text</span> <span class='ss'>:category</span> <span class='k'>do</span>
      <span class='n'>category</span><span class='o'>.</span><span class='n'>title</span>
    <span class='k'>end</span>
    <span class='n'>text</span> <span class='ss'>:brand</span> <span class='k'>do</span>
      <span class='n'>brand</span><span class='o'>.</span><span class='n'>title</span>
    <span class='k'>end</span>
  <span class='k'>end</span> <span class='c1'># do</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>PostgreSQL search index might be yet another column in the database, set by pre save hook:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>Product</span> <span class='o'>&lt;</span> <span class='no'>ActiveRecord</span><span class='o'>::</span><span class='no'>Base</span>

  <span class='n'>before_validation</span> <span class='ss'>:set_searchable_content</span>
  <span class='kp'>protected</span>
  <span class='k'>def</span> <span class='nf'>set_searchable_content</span>
    <span class='nb'>self</span><span class='o'>.</span><span class='n'>searchable_content</span> <span class='o'>=</span> <span class='o'>[</span><span class='n'>title</span><span class='p'>,</span> <span class='n'>material</span><span class='p'>,</span> <span class='n'>category</span><span class='o'>.</span><span class='n'>title</span><span class='p'>,</span> <span class='n'>brand</span><span class='o'>.</span><span class='n'>title</span><span class='o'>].</span><span class='n'>join</span><span class='p'>(</span><span class='s2'>&quot; &quot;</span><span class='p'>)</span>
  <span class='k'>end</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>And don’t forget about database index:</p>
<div class='highlight'><pre><code class='sql'><span class='k'>CREATE</span> <span class='k'>INDEX</span> <span class='n'>source_idx</span> <span class='k'>ON</span> <span class='n'>products</span> <span class='k'>USING</span> <span class='n'>gin</span><span class='p'>(</span><span class='n'>to_tsvector</span><span class='p'>(</span><span class='s1'>&#39;english&#39;</span><span class='p'>,</span> <span class='n'>searchable_content</span><span class='p'>));</span> 
</code></pre>
</div>
<p>While this is very basic use case, it shows up the direction where your code will go in each variant.</p>

<ul>
<li>Advanced high level DSL with a lot of “unknown unknowns” in Solr case</li>

<li>Just ruby code that everyone would understand from the first look in case of Postgres</li>
</ul>

<p>As an example of how you would solve more advanced problem, I want to show facet search implementation:</p>
<div class='highlight'><pre><code class='ruby'><span class='c1'># Suppose to receive a list of ids to count between different categories</span>
<span class='k'>def</span> <span class='nc'>self</span><span class='o'>.</span><span class='nf'>search_facets</span><span class='p'>(</span><span class='n'>ids</span><span class='p'>)</span>
  <span class='k'>return</span> <span class='o'>[]</span> <span class='k'>if</span> <span class='n'>ids</span><span class='o'>.</span><span class='n'>blank?</span>
  <span class='no'>ProductCategory</span><span class='o'>.</span><span class='n'>select</span><span class='p'>(</span><span class='s2'>&quot;product_categories.id, count(product_categories.id) as product_count&quot;</span><span class='p'>)</span><span class='o'>.</span>
     <span class='n'>joins</span><span class='p'>(</span><span class='ss'>:products</span><span class='p'>)</span><span class='o'>.</span>
     <span class='n'>where</span><span class='p'>(</span><span class='s2'>&quot;products.id&quot;</span> <span class='o'>=&gt;</span> <span class='n'>ids</span><span class='p'>)</span><span class='o'>.</span>
     <span class='n'>group</span><span class='p'>(</span><span class='s2'>&quot;product_categories.id&quot;</span><span class='p'>)</span><span class='o'>.</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>While Solr based facet would be easier:</p>
<div class='highlight'><pre><code class='ruby'><span class='no'>Product</span><span class='o'>.</span><span class='n'>search</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>s</span><span class='o'>|</span>
  <span class='n'>s</span><span class='o'>.</span><span class='n'>keywords</span> <span class='n'>params</span><span class='o'>[</span><span class='ss'>:query</span><span class='o'>]</span>
  <span class='n'>s</span><span class='o'>.</span><span class='n'>facet</span> <span class='ss'>:category_id</span>
  <span class='n'>s</span><span class='o'>.</span><span class='n'>paginate</span> <span class='ss'>:page</span> <span class='o'>=&gt;</span> <span class='n'>params</span><span class='o'>[</span><span class='ss'>:page</span><span class='o'>]</span><span class='p'>,</span> <span class='ss'>:per_page</span> <span class='o'>=&gt;</span> <span class='mi'>10</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>At first look you might say that Solr way is more clear, but you still don’t know what it does in deep details. Sunspot gives DSL is yet another language to query data. It includes all types of operations (e.g. <a href="https://github.com/sunspot/sunspot/wiki/Scoping-by-attribute-fields">comparison operators</a>, while postgres lets use SQL - language you should know already.</p>

<p>There is also easy to spot that Solr and Sunspot tool chain brings more features to you out of the box. But this is where Solr advantages ends. Note stat Solr config file is not as readable as Sunspot DSL. Here is a short example that tells Solr to do some string transformation before create a search index:</p>
<div class='highlight'><pre><code class='xml'><span class='nt'>&lt;fieldType</span> <span class='na'>name=</span><span class='s'>&quot;text&quot;</span> <span class='na'>class=</span><span class='s'>&quot;solr.TextField&quot;</span> <span class='na'>omitNorms=</span><span class='s'>&quot;false&quot;</span><span class='nt'>&gt;</span>
  <span class='nt'>&lt;analyzer&gt;</span>
    <span class='nt'>&lt;tokenizer</span> <span class='na'>class=</span><span class='s'>&quot;solr.StandardTokenizerFactory&quot;</span><span class='nt'>/&gt;</span>
    <span class='c'>&lt;!-- remove punctualtion --&gt;</span>
    <span class='nt'>&lt;filter</span> <span class='na'>class=</span><span class='s'>&quot;solr.StandardFilterFactory&quot;</span><span class='nt'>/&gt;</span>
    <span class='c'>&lt;!-- lower case letters --&gt;</span>
    <span class='nt'>&lt;filter</span> <span class='na'>class=</span><span class='s'>&quot;solr.LowerCaseFilterFactory&quot;</span><span class='nt'>/&gt;</span>
    <span class='c'>&lt;!-- language semantic support --&gt;</span>
    <span class='nt'>&lt;filter</span> <span class='na'>class=</span><span class='s'>&quot;solr.SnowballPorterFilterFactory&quot;</span> <span class='na'>language=</span><span class='s'>&quot;English&quot;</span><span class='nt'>/&gt;</span>
  <span class='nt'>&lt;/analyzer&gt;</span>
<span class='nt'>&lt;/fieldType&gt;</span>
</code></pre>
</div>
<p>When you go deeper into solr you might need to deal with configs like example above. While in case of PostgreSQL you can do any string transformation using ruby.</p>

<h2 id="deployment_and_testing">Deployment and Testing</h2>

<p>Solr is a standalone application and you need to take care about Solr configuration. It is a part of a code since some search business logic depends on it. This might require:</p>

<ul>
<li>different solr config files across different branches</li>

<li>test suite that covers some config options</li>

<li>different solr instances launched for development and test environments</li>

<li>a need to rebuild search index when you switch branches</li>
</ul>

<p>Postgres built in search doesn’t have these problems at all. This will give a significant performance boost in agile process. Deployment, testing and switching branches doesn’t require any full text search specific action.</p>

<h2 id="reindex_process">Reindex process</h2>

<p>Reindex complexity comes from several factors.</p>

<p>First of them is complicated search index that cover more than one model (Ex: <code>Product.belongs_to :brand</code> and <code>Brand#title</code> should be a part of <code>Product</code> index). It makes both approaches more complex as business logic becomes more complex.</p>

<p>But in case of Solr this is not the only one thing to care. With database size growth you gain more problems. Solr index do not have that nice migration mechanism and dump transfer tools as Relational databases. No matter which gem you will use to connect Solr and Relational database: you need to take care when search index schema changes.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Conceptually I would like my database to respond for every data search operation e.g. full text search. This is where PostgreSQL is going. But this feature is not that strong now e.g. it still lacks spell checking and result highlight features. Solr is old school tool having all full text search features you ever imagine, but it’s heavy configuration file and technology stack should be easier.</p>
-->
        <h4 class="tags">
    
    <a href="/tags/solr.html">solr</a>
    
    <a href="/tags/sunspot.html">sunspot</a>
    
    <a href="/tags/postgresql.html">postgresql</a>
    
    <a href="/tags/fulltext.html">fulltext</a>
    
    <a href="/tags/search.html">search</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>


<div class='paginator'>
    
        <div class='next'>
            <a href='/page2'>
                Earlier posts &rarr;
            </a>
        </div>
    
    
    <div class='clear'></div>
</div>

                </div>
                <div class="vsplit">
                </div>
                <div id="sidebar">
                    <div class="recent-posts">
                        <h2>Recent Posts</h2>
                        <a class="rss" href="http://feeds.feedburner.com/BogdanGusiev">
                            <img src="/images/rss.png" alt="Bogdan Gusiev&#8217;s blog" />
                        </a>
                        <div class="clear"></div>
                        <ul>
                            
                            <li>
                                <a href='/2014/04/state-machine-minemalistic-validation-perfection-changes'>Minimalistic State Machine: Less is More</a>
                            </li>
                            
                            <li>
                                <a href='/2013/11/datagrid-slides-report-framework'>Datagrid slides from Ruby Meditation 3</a>
                            </li>
                            
                            <li>
                                <a href='/2013/05/rails-ajax-validation-form-submit-javascript'>Support validation through ajax in Rails 4.x</a>
                            </li>
                            
                            <li>
                                <a href='/2013/04/git-story-id-pivotal-tracker-integration'>Attach git commits to pivotal stories</a>
                            </li>
                            
                            <li>
                                <a href='/2013/04/background-jobs-frameworkds-delayed-job-resque-slides'>Background Jobs Frameworks: Resque vs DelayedJob</a>
                            </li>
                            
                        </ul>
                    </div>
                    <div class="slides">
                      <h2>Slides</h2>
                      <ul>
                        <li>
                          <a href="/slides/datagrid/index.html#/">Datagrid - table data framework</a>
                        </li>
                        <li>
                          <a href='/dorspec#1'>Fogotten Features of RSpec</a>
                        </li>
                        <li>
                          <a href='/slides/rails_contribution/static/#1'>Power Hacking Rails internals</a>
                        </li>
                        <li>
                          <a href='/slides/fighting_fat_models/static'>Fighting Fat Models</a>
                        </li>
                        <li>
                          <a href='/slides/background-jobs-frameworks/static/#1'>Background job Frameworks</a>
                        </li>
                      </ul>
                    </div>
                    <div class="sidebarbox">
                        <h2>Search</h2>
                        <form method="get" id="searchform" action="">
    <input type="text" placeholder="Search keywords" name="s" id="searchbox"/>
    <input type="submit" class="submitbutton" value="Find" />
</form>
<script>
    $('#searchform').submit(function(event) {
    event.preventDefault();
    window.location.href = "http://google.com/search?q=site:gusiev.com " + $('#searchbox').val();
    });
</script>

                    </div>
                    <div class="sidebarbox tag-cloud">
                        <h2>Browse by tags</h2>
                        <a href="/tags/activerecord.html" title="Pages tagged activerecord" style="font-size: 23.0px; line-height:23.0px" rel="tag">activerecord</a> 
<a href="/tags/ajax.html" title="Pages tagged ajax" style="font-size: 21.2px; line-height:21.2px" rel="tag">ajax</a> 
<a href="/tags/api.html" title="Pages tagged api" style="font-size: 17.6px; line-height:17.6px" rel="tag">api</a> 
<a href="/tags/application.html" title="Pages tagged application" style="font-size: 17.6px; line-height:17.6px" rel="tag">application</a> 
<a href="/tags/bdd.html" title="Pages tagged bdd" style="font-size: 17.6px; line-height:17.6px" rel="tag">bdd</a> 
<a href="/tags/behavior.html" title="Pages tagged behavior" style="font-size: 19.4px; line-height:19.4px" rel="tag">behavior</a> 
<a href="/tags/changelog.html" title="Pages tagged changelog" style="font-size: 17.6px; line-height:17.6px" rel="tag">changelog</a> 
<a href="/tags/class.html" title="Pages tagged class" style="font-size: 17.6px; line-height:17.6px" rel="tag">class</a> 
<a href="/tags/commit.html" title="Pages tagged commit" style="font-size: 17.6px; line-height:17.6px" rel="tag">commit</a> 
<a href="/tags/context.html" title="Pages tagged context" style="font-size: 17.6px; line-height:17.6px" rel="tag">context</a> 
<a href="/tags/contribution.html" title="Pages tagged contribution" style="font-size: 24.8px; line-height:24.8px" rel="tag">contribution</a> 
<a href="/tags/criticism.html" title="Pages tagged criticism" style="font-size: 26.6px; line-height:26.6px" rel="tag">criticism</a> 
<a href="/tags/database.html" title="Pages tagged database" style="font-size: 19.4px; line-height:19.4px" rel="tag">database</a> 
<a href="/tags/datagrid.html" title="Pages tagged datagrid" style="font-size: 19.4px; line-height:19.4px" rel="tag">datagrid</a> 
<a href="/tags/debug.html" title="Pages tagged debug" style="font-size: 19.4px; line-height:19.4px" rel="tag">debug</a> 
<a href="/tags/dry.html" title="Pages tagged dry" style="font-size: 19.4px; line-height:19.4px" rel="tag">dry</a> 
<a href="/tags/gem.html" title="Pages tagged gem" style="font-size: 24.8px; line-height:24.8px" rel="tag">gem</a> 
<a href="/tags/git.html" title="Pages tagged git" style="font-size: 17.6px; line-height:17.6px" rel="tag">git</a> 
<a href="/tags/howto.html" title="Pages tagged howto" style="font-size: 21.2px; line-height:21.2px" rel="tag">howto</a> 
<a href="/tags/html.html" title="Pages tagged html" style="font-size: 21.2px; line-height:21.2px" rel="tag">html</a> 
<a href="/tags/idea.html" title="Pages tagged idea" style="font-size: 17.6px; line-height:17.6px" rel="tag">idea</a> 
<a href="/tags/java.html" title="Pages tagged java" style="font-size: 21.2px; line-height:21.2px" rel="tag">java</a> 
<a href="/tags/javascript.html" title="Pages tagged javascript" style="font-size: 28.4px; line-height:28.4px" rel="tag">javascript</a> 
<a href="/tags/jquery.html" title="Pages tagged jquery" style="font-size: 17.6px; line-height:17.6px" rel="tag">jquery</a> 
<a href="/tags/patch.html" title="Pages tagged patch" style="font-size: 17.6px; line-height:17.6px" rel="tag">patch</a> 
<a href="/tags/pattern.html" title="Pages tagged pattern" style="font-size: 17.6px; line-height:17.6px" rel="tag">pattern</a> 
<a href="/tags/performance.html" title="Pages tagged performance" style="font-size: 19.4px; line-height:19.4px" rel="tag">performance</a> 
<a href="/tags/programming.html" title="Pages tagged programming" style="font-size: 21.2px; line-height:21.2px" rel="tag">programming</a> 
<a href="/tags/query.html" title="Pages tagged query" style="font-size: 17.6px; line-height:17.6px" rel="tag">query</a> 
<a href="/tags/rails.html" title="Pages tagged rails" style="font-size: 39.2px; line-height:39.2px" rel="tag">rails</a> 
<a href="/tags/report.html" title="Pages tagged report" style="font-size: 17.6px; line-height:17.6px" rel="tag">report</a> 
<a href="/tags/resque.html" title="Pages tagged resque" style="font-size: 17.6px; line-height:17.6px" rel="tag">resque</a> 
<a href="/tags/rspec.html" title="Pages tagged rspec" style="font-size: 23.0px; line-height:23.0px" rel="tag">rspec</a> 
<a href="/tags/ruby.html" title="Pages tagged ruby" style="font-size: 28.4px; line-height:28.4px" rel="tag">ruby</a> 
<a href="/tags/service.html" title="Pages tagged service" style="font-size: 19.4px; line-height:19.4px" rel="tag">service</a> 
<a href="/tags/slides.html" title="Pages tagged slides" style="font-size: 23.0px; line-height:23.0px" rel="tag">slides</a> 
<a href="/tags/sql.html" title="Pages tagged sql" style="font-size: 19.4px; line-height:19.4px" rel="tag">sql</a> 
<a href="/tags/test.html" title="Pages tagged test" style="font-size: 19.4px; line-height:19.4px" rel="tag">test</a> 
<a href="/tags/usability.html" title="Pages tagged usability" style="font-size: 17.6px; line-height:17.6px" rel="tag">usability</a> 
<a href="/tags/validation.html" title="Pages tagged validation" style="font-size: 23.0px; line-height:23.0px" rel="tag">validation</a> 
<a href="/tags/vim.html" title="Pages tagged vim" style="font-size: 17.6px; line-height:17.6px" rel="tag">vim</a> 

                    </div>
                </div><!-- Closes Sidebar_full -->
                <div class="clear"></div>
            </div> <!-- Closes Sidebar -->
            <div class="clear"></div>

        </div><!-- Closes Main -->


        <div class="footer">
            <hr/>
            <!--LiveInternet counter-->

            <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                document.write("<a href='http://www.liveinternet.ru/click' "+
                        "target=_blank><img src='http://counter.yadro.ru/hit?t40.6;r"+
                        escape(document.referrer)+((typeof(screen)=="undefined")?"":
                            ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
                                screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
                        ";"+Math.random()+
                        "' alt='' title='LiveInternet' "+
                        "border='0' width='31' height='31'><\/a>");
                }
                </script><!--/LiveInternet-->
                <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
                    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
                }
                    </script>
                    <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                        try {
                            var pageTracker = _gat._getTracker("UA-12663165-1");
                            pageTracker._trackPageview();
                        } catch(err) {}
                }</script>

            <div style="text-align: center; padding-right: 350px">
                The Content of this blog can be published anywhere with the link to original source.
            </div>
        </div><!-- Closes morefoot -->




    </body>
</html>



