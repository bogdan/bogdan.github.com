<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

    <title>
      
        Minimalistic State Machine: Less is More -
      
      Bogdan's blog
    </title>
    <meta name="robots" content="follow, all" />
    <meta charset="utf-8"> 
    
    <meta name="description" content="This is personal blog of Bogdan Gusiev: ruby on rails developer, open source contributor">
    <meta name="keywords" content="activerecord, ajax, api, application, bdd, behavior, changelog, class, commit, context, contribution, criticism, database, datagrid, debug, dry, gem, git, howto, html, idea, java, javascript, jquery, patch, pattern, performance, programming, query, rails, report, resque, rspec, ruby, service, slides, sql, test, usability, validation, vim" />
    <link rel="stylesheet" href="/css/default.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/highlight.css" type="text/css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Bogdan Gusiev's blog RSS Feed" href="http://feeds.feedburner.com/BogdanGusiev" />
    <link rel="shortcut icon" href="/images/favicon.ico"/>
    <link rel="icon" href="/images/favicon.ico"/>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                var params = decodeURI(window.location.search).replace(/^\?/, "").split("&");
                $(params).each(function(index, param) {
                    if (param.match(/^p=/)) {

                        switch(parseInt(param.split("=")[1])) {
                            case 11: window.location.href = "http://www.gusiev.com/2009/04/clear-upload-file-input-field/";
                            break;
                            case 3: window.location.href = "http://www.gusiev.com/2009/04/upload-files-with-selenium-ide/";
                            break;
                        }
                    }
                })
            });
        </script>
    </head>

    <body>
      <div id="fb-root"></div>
      <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=354906294546402";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));</script>
        <a href="http://github.com/bogdan" class="fork">
            <img src="/images/fork.png"/>
        </a>

        <div id="wrapper">

            <div class="header">
                <div class="title">
                    <h1><a href="/">Bogdan Gusiev's blog</a></h1>
                    <h4>How to make good software <a class="for-people" href="/pages/about.html#dream_job">for people</a></h4>
                </div>

                <div class="pages">
                    <a href="/">Home</a>
                    <a href="/pages/about.html">About me</a>
                    <a href="/pages/contacts.html">Contacts</a>
                </div>
                <a href="/pages/about.html" class="avatar">
                    <img src="/images/me.jpg"/>
                </a>
                <div class="clear"></div>
                <hr/>
            </div> <!-- Closes header -->


            <div id="main">

                <div id="content">
                    <div id="post">
    <h2>
        <a href="/2014/04/state-machine-minemalistic-validation-perfection-changes">Minimalistic State Machine: Less is More</a>
        <div class="date">01 Apr 2014</div>
    </h2>
    
<p>I have tried a bunch of ActiveRecord’s state machine gems. Their functionality is very close to each other. It allows to validate a state transition and reinvent ruby programming language to define transition methods. The fact that all of them produces custom API to define a ruby method doesn’t look right… <!--more--></p>

<h3 id="samples_using_common_state_machine_gems">Samples using common state machine gems</h3>
<div class='highlight'><pre><code class='ruby'><span class='c1'># State Machine gem example</span>
<span class='n'>state_machine</span> <span class='ss'>:state</span><span class='p'>,</span> <span class='ss'>:initial</span> <span class='o'>=&gt;</span> <span class='ss'>:parked</span> <span class='k'>do</span>
  <span class='n'>event</span> <span class='ss'>:approve!</span> <span class='k'>do</span>
    <span class='n'>transition</span> <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='ss'>:approved</span>
  <span class='k'>end</span>
  <span class='n'>after_transition</span> <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:do</span> <span class='o'>=&gt;</span> <span class='ss'>:send_approval_email</span>
<span class='k'>end</span>

<span class='c1'># Workflow gem example</span>
<span class='n'>workflow</span> <span class='k'>do</span>
  <span class='n'>state</span> <span class='ss'>:pending</span> <span class='k'>do</span>
    <span class='n'>event</span> <span class='ss'>:approve!</span><span class='p'>,</span> <span class='ss'>:transitions_to</span> <span class='o'>=&gt;</span> <span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:after_transition</span> <span class='o'>=&gt;</span> <span class='ss'>:send_approval_email</span>
  <span class='k'>end</span>
<span class='k'>end</span>

<span class='c1'># And finally plain ruby/rails example</span>
<span class='k'>def</span> <span class='nf'>approve!</span>
  <span class='n'>update_attributes!</span><span class='p'>(</span><span class='ss'>:state</span> <span class='o'>=&gt;</span> <span class='s2'>&quot;approved&quot;</span><span class='p'>)</span>
  <span class='n'>send_approval_email</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Maybe I don’t know all modern trends but ruby version looks more human readable to me.</p>

<h3 id="so_why_do_we_still_tend_to_use_state_machine_gems">So why do we still tend to use state machine gems</h3>

<p>The main reason is state change validation. It won’t be easy to always check if it is possible to transition object from state A to state B in plain Ruby. This part of state machine is something that really matter.</p>

<p>In my head it appears as some kind of allowed changes map:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>order_state_changes_map</span> <span class='o'>=</span> <span class='p'>{</span> 
  <span class='kp'>nil</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:pending</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Initial state is always pending</span>
  <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:rejected</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Pending can be changed to to paid and delivered</span>
  <span class='ss'>:approved</span> <span class='o'>=&gt;</span> <span class='ss'>:paid</span> <span class='c1'># Delivered can only be changed to paid</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>If the state machine’s main goal is to validate changes than let’s implement it as a validation:</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>Order</span> <span class='o'>&lt;</span> <span class='no'>AR</span><span class='o'>::</span><span class='no'>Base</span>
  <span class='n'>validates</span> <span class='ss'>:state</span><span class='p'>,</span> <span class='ss'>:changes</span> <span class='o'>=&gt;</span> <span class='n'>order_state_changes_map</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>With this pattern you can define state change methods in ruby:</p>
<div class='highlight'><pre><code class='ruby'><span class='n'>validates</span> <span class='ss'>:state</span><span class='p'>,</span> <span class='ss'>:changes</span> <span class='o'>=&gt;</span> <span class='p'>{</span> 
  <span class='kp'>nil</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:pending</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Initial state is always pending</span>
  <span class='ss'>:pending</span> <span class='o'>=&gt;</span> <span class='o'>[</span><span class='ss'>:approved</span><span class='p'>,</span> <span class='ss'>:rejected</span><span class='o'>]</span><span class='p'>,</span> <span class='c1'># Pending can be changed to to paid and delivered</span>
  <span class='ss'>:approved</span> <span class='o'>=&gt;</span> <span class='ss'>:paid</span> <span class='c1'># Delivered can only be changed to paid</span>
<span class='p'>}</span>

<span class='k'>def</span> <span class='nf'>upproved!</span>
  <span class='c1'># ....</span>
<span class='k'>end</span>

<span class='k'>def</span> <span class='nf'>upproved?</span>
  <span class='c1'># ....</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>Now it looks really readable and a person who never saw this kind of API before can figure out what is happening.</p>

<p>Give a try to: <a href="https://github.com/bogdan/changes_validator">ChangesValidator</a> in your app</p>

    <div class="clear"></div>
    <div class="left">
      <table class="post-social-share">
        <tr>
          <td>
            <a href="https://twitter.com/share" class="twitter-share-button" data-lang="en" data-text="Minimalistic State Machine: Less is More" data-via="bgusiev" data-url="http://gusiev.com/2014/04/state-machine-minemalistic-validation-perfection-changes">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
          </td>
          <td>
            <div class="fb-like" data-href="http://gusiev.com/2014/04/state-machine-minemalistic-validation-perfection-changes" data-send="false" data-layout="button_count" data-width="25" data-show-faces="true"></div>
          </td>
          <td>
            <div class="reddit-button">
              <script type="text/javascript" src="http://www.reddit.com/static/button/button1.js"></script>
            </div>
          </td>
        </tr>
      </table>
    </div>

    <h4 class="tags">
    
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/validation.html">validation</a>
    
    <a href="/tags/statemachine.html">statemachine</a>
    
    <a href="/tags/criticism.html">criticism</a>
    
</h4>
<div class="clear"></div>

    <div id="related">
        <h3>Related Posts</h3>
        <ul class="posts">
            
               <!-- Exclude self -->
                <li><span>16 Aug 2012</span> &raquo; <a href="/2012/08/postgresql-full-text-search-solr">Full text search - Solr(Sunspot) vs PostgreSQL</a></li>
              
            
               <!-- Exclude self -->
                <li><span>06 Jun 2012</span> &raquo; <a href="/2012/06/assumption-driven-development">Assumption Driven Approach</a></li>
              
            
               <!-- Exclude self -->
                <li><span>08 Oct 2012</span> &raquo; <a href="/2012/10/crazy-javascript-initialization-strategy">Smart Javascript Initialization Strategy</a></li>
              
            
               <!-- Exclude self -->
                <li><span>23 Jan 2012</span> &raquo; <a href="/2012/01/rails-32-features-changelog">New Rails Release with a few features from me</a></li>
              
            
        </ul>
    </div>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'gusiev'; // required: replace example with your forum shortname

    //var disqus_identifier = '/2014/04/state-machine-minemalistic-validation-perfection-changes';
    //var disqus_url = 'http://gusiev.com/2014/04/state-machine-minemalistic-validation-perfection-changes';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
</div>


                </div>
                <div class="vsplit">
                </div>
                <div id="sidebar">
                    <div class="recent-posts">
                        <h2>Recent Posts</h2>
                        <a class="rss" href="http://feeds.feedburner.com/BogdanGusiev">
                            <img src="/images/rss.png" alt="Bogdan Gusiev&#8217;s blog" />
                        </a>
                        <div class="clear"></div>
                        <ul>
                            
                            <li>
                                <a href='/2014/04/state-machine-minemalistic-validation-perfection-changes'>Minimalistic State Machine: Less is More</a>
                            </li>
                            
                            <li>
                                <a href='/2013/11/datagrid-slides-report-framework'>Datagrid slides from Ruby Meditation 3</a>
                            </li>
                            
                            <li>
                                <a href='/2013/05/rails-ajax-validation-form-submit-javascript'>Support validation through ajax in Rails 4.x</a>
                            </li>
                            
                            <li>
                                <a href='/2013/04/git-story-id-pivotal-tracker-integration'>Attach git commits to pivotal stories</a>
                            </li>
                            
                            <li>
                                <a href='/2013/04/background-jobs-frameworkds-delayed-job-resque-slides'>Background Jobs Frameworks: Resque vs DelayedJob</a>
                            </li>
                            
                        </ul>
                    </div>
                    <div class="slides">
                      <h2>Slides</h2>
                      <ul>
                        <li>
                          <a href="/slides/datagrid/index.html#/">Datagrid - table data framework</a>
                        </li>
                        <li>
                          <a href='/dorspec#1'>Fogotten Features of RSpec</a>
                        </li>
                        <li>
                          <a href='/slides/rails_contribution/static/#1'>Power Hacking Rails internals</a>
                        </li>
                        <li>
                          <a href='/slides/fighting_fat_models/static'>Fighting Fat Models</a>
                        </li>
                        <li>
                          <a href='/slides/background-jobs-frameworks/static/#1'>Background job Frameworks</a>
                        </li>
                      </ul>
                    </div>
                    <div class="sidebarbox">
                        <h2>Search</h2>
                        <form method="get" id="searchform" action="">
    <input type="text" placeholder="Search keywords" name="s" id="searchbox"/>
    <input type="submit" class="submitbutton" value="Find" />
</form>
<script>
    $('#searchform').submit(function(event) {
    event.preventDefault();
    window.location.href = "http://google.com/search?q=site:gusiev.com " + $('#searchbox').val();
    });
</script>

                    </div>
                    <div class="sidebarbox tag-cloud">
                        <h2>Browse by tags</h2>
                        <a href="/tags/activerecord.html" title="Pages tagged activerecord" style="font-size: 23.0px; line-height:23.0px" rel="tag">activerecord</a> 
<a href="/tags/ajax.html" title="Pages tagged ajax" style="font-size: 21.2px; line-height:21.2px" rel="tag">ajax</a> 
<a href="/tags/api.html" title="Pages tagged api" style="font-size: 17.6px; line-height:17.6px" rel="tag">api</a> 
<a href="/tags/application.html" title="Pages tagged application" style="font-size: 17.6px; line-height:17.6px" rel="tag">application</a> 
<a href="/tags/bdd.html" title="Pages tagged bdd" style="font-size: 17.6px; line-height:17.6px" rel="tag">bdd</a> 
<a href="/tags/behavior.html" title="Pages tagged behavior" style="font-size: 19.4px; line-height:19.4px" rel="tag">behavior</a> 
<a href="/tags/changelog.html" title="Pages tagged changelog" style="font-size: 17.6px; line-height:17.6px" rel="tag">changelog</a> 
<a href="/tags/class.html" title="Pages tagged class" style="font-size: 17.6px; line-height:17.6px" rel="tag">class</a> 
<a href="/tags/commit.html" title="Pages tagged commit" style="font-size: 17.6px; line-height:17.6px" rel="tag">commit</a> 
<a href="/tags/context.html" title="Pages tagged context" style="font-size: 17.6px; line-height:17.6px" rel="tag">context</a> 
<a href="/tags/contribution.html" title="Pages tagged contribution" style="font-size: 24.8px; line-height:24.8px" rel="tag">contribution</a> 
<a href="/tags/criticism.html" title="Pages tagged criticism" style="font-size: 26.6px; line-height:26.6px" rel="tag">criticism</a> 
<a href="/tags/database.html" title="Pages tagged database" style="font-size: 19.4px; line-height:19.4px" rel="tag">database</a> 
<a href="/tags/datagrid.html" title="Pages tagged datagrid" style="font-size: 19.4px; line-height:19.4px" rel="tag">datagrid</a> 
<a href="/tags/debug.html" title="Pages tagged debug" style="font-size: 19.4px; line-height:19.4px" rel="tag">debug</a> 
<a href="/tags/dry.html" title="Pages tagged dry" style="font-size: 19.4px; line-height:19.4px" rel="tag">dry</a> 
<a href="/tags/gem.html" title="Pages tagged gem" style="font-size: 24.8px; line-height:24.8px" rel="tag">gem</a> 
<a href="/tags/git.html" title="Pages tagged git" style="font-size: 17.6px; line-height:17.6px" rel="tag">git</a> 
<a href="/tags/howto.html" title="Pages tagged howto" style="font-size: 21.2px; line-height:21.2px" rel="tag">howto</a> 
<a href="/tags/html.html" title="Pages tagged html" style="font-size: 21.2px; line-height:21.2px" rel="tag">html</a> 
<a href="/tags/idea.html" title="Pages tagged idea" style="font-size: 17.6px; line-height:17.6px" rel="tag">idea</a> 
<a href="/tags/java.html" title="Pages tagged java" style="font-size: 21.2px; line-height:21.2px" rel="tag">java</a> 
<a href="/tags/javascript.html" title="Pages tagged javascript" style="font-size: 28.4px; line-height:28.4px" rel="tag">javascript</a> 
<a href="/tags/jquery.html" title="Pages tagged jquery" style="font-size: 17.6px; line-height:17.6px" rel="tag">jquery</a> 
<a href="/tags/patch.html" title="Pages tagged patch" style="font-size: 17.6px; line-height:17.6px" rel="tag">patch</a> 
<a href="/tags/pattern.html" title="Pages tagged pattern" style="font-size: 17.6px; line-height:17.6px" rel="tag">pattern</a> 
<a href="/tags/performance.html" title="Pages tagged performance" style="font-size: 19.4px; line-height:19.4px" rel="tag">performance</a> 
<a href="/tags/programming.html" title="Pages tagged programming" style="font-size: 21.2px; line-height:21.2px" rel="tag">programming</a> 
<a href="/tags/query.html" title="Pages tagged query" style="font-size: 17.6px; line-height:17.6px" rel="tag">query</a> 
<a href="/tags/rails.html" title="Pages tagged rails" style="font-size: 39.2px; line-height:39.2px" rel="tag">rails</a> 
<a href="/tags/report.html" title="Pages tagged report" style="font-size: 17.6px; line-height:17.6px" rel="tag">report</a> 
<a href="/tags/resque.html" title="Pages tagged resque" style="font-size: 17.6px; line-height:17.6px" rel="tag">resque</a> 
<a href="/tags/rspec.html" title="Pages tagged rspec" style="font-size: 23.0px; line-height:23.0px" rel="tag">rspec</a> 
<a href="/tags/ruby.html" title="Pages tagged ruby" style="font-size: 28.4px; line-height:28.4px" rel="tag">ruby</a> 
<a href="/tags/service.html" title="Pages tagged service" style="font-size: 19.4px; line-height:19.4px" rel="tag">service</a> 
<a href="/tags/slides.html" title="Pages tagged slides" style="font-size: 23.0px; line-height:23.0px" rel="tag">slides</a> 
<a href="/tags/sql.html" title="Pages tagged sql" style="font-size: 19.4px; line-height:19.4px" rel="tag">sql</a> 
<a href="/tags/test.html" title="Pages tagged test" style="font-size: 19.4px; line-height:19.4px" rel="tag">test</a> 
<a href="/tags/usability.html" title="Pages tagged usability" style="font-size: 17.6px; line-height:17.6px" rel="tag">usability</a> 
<a href="/tags/validation.html" title="Pages tagged validation" style="font-size: 23.0px; line-height:23.0px" rel="tag">validation</a> 
<a href="/tags/vim.html" title="Pages tagged vim" style="font-size: 17.6px; line-height:17.6px" rel="tag">vim</a> 

                    </div>
                </div><!-- Closes Sidebar_full -->
                <div class="clear"></div>
            </div> <!-- Closes Sidebar -->
            <div class="clear"></div>

        </div><!-- Closes Main -->


        <div class="footer">
            <hr/>
            <!--LiveInternet counter-->

            <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                document.write("<a href='http://www.liveinternet.ru/click' "+
                        "target=_blank><img src='http://counter.yadro.ru/hit?t40.6;r"+
                        escape(document.referrer)+((typeof(screen)=="undefined")?"":
                            ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
                                screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
                        ";"+Math.random()+
                        "' alt='' title='LiveInternet' "+
                        "border='0' width='31' height='31'><\/a>");
                }
                </script><!--/LiveInternet-->
                <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
                    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
                }
                    </script>
                    <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                        try {
                            var pageTracker = _gat._getTracker("UA-12663165-1");
                            pageTracker._trackPageview();
                        } catch(err) {}
                }</script>

            <div style="text-align: center; padding-right: 350px">
                The Content of this blog can be published anywhere with the link to original source.
            </div>
        </div><!-- Closes morefoot -->




    </body>
</html>



