<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

    <title>
      
      Bogdan's blog
    </title>
    <meta name="robots" content="follow, all" />
    <meta name="description" content="This is personal blog of Bogdan Gusiev: ruby on rails developer, open source contributor">
    <meta name="keywords" content="activerecord, ajax, api, application, bdd, behavior, changelog, class, commit, context, contribution, criticism, database, datagrid, debug, dry, gem, git, howto, html, idea, java, javascript, jquery, patch, pattern, performance, programming, query, rails, report, resque, rspec, ruby, service, slides, sql, test, usability, validation, vim" />
    <link rel="stylesheet" href="/css/default.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/highlight.css" type="text/css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Bogdan Gusiev's blog RSS Feed" href="http://feeds.feedburner.com/BogdanGusiev" />
    <link rel="shortcut icon" href="/images/favicon.ico"/>
    <link rel="icon" href="/images/favicon.ico"/>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                var params = decodeURI(window.location.search).replace(/^\?/, "").split("&");
                $(params).each(function(index, param) {
                    if (param.match(/^p=/)) {

                        switch(parseInt(param.split("=")[1])) {
                            case 11: window.location.href = "http://www.gusiev.com/2009/04/clear-upload-file-input-field/";
                            break;
                            case 3: window.location.href = "http://www.gusiev.com/2009/04/upload-files-with-selenium-ide/";
                            break;
                        }
                    }
                })
            });
        </script>
    </head>

    <body>
      <div id="fb-root"></div>
      <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=354906294546402";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));</script>
        <a href="http://github.com/bogdan" class="fork">
            <img src="/images/fork.png"/>
        </a>

        <div id="wrapper">

            <div class="header">
                <div class="title">
                    <h1><a href="/">Bogdan Gusiev's blog</a></h1>
                    <h4>How to make good software <a class="for-people" href="/pages/about.html#dream_job">for people</a></h4>
                </div>

                <div class="pages">
                    <a href="/">Home</a>
                    <a href="/pages/about.html">About me</a>
                    <a href="/pages/contacts.html">Contacts</a>
                </div>
                <a href="/pages/about.html" class="avatar">
                    <img src="/images/me.jpg"/>
                </a>
                <div class="clear"></div>
                <hr/>
            </div> <!-- Closes header -->


            <div id="main">

                <div id="content">
                    
    <div class="post">
        <h2>
            <a href='/2011/05/dbext-vim-table-names-convention-patch'>Patching dbext vim plugin to support Rails naming conventions</a>
            <div class="date">30 May 2011</div>
        </h2>
        <p><a href='http://www.vim.org/scripts/script.php?script_id=356'>dbext</a> is an excellent vim plugin that allows you to execute SQL queries directly from vim. For example: <code>select * from &lt;word under cursor&gt;</code>. When dbext is used with Rails there is a problem that you can work with some variation of table name like:</p>

<ul>
<li>UserRole</li>

<li>user_role_id</li>

<li>user_role_ids</li>

<li>user_role</li>
</ul>

<p>But still wants to use it as table name in your database queries so that you won&#8217;t type it manually.</p>
<!--
<p>So, I made it to automatically convert word under cursor into a table name with the following configuration options:</p>

<pre><code>let g:dbext_table_names_number = 2 
    # 0 - disabled, 1 - singular, 2 - plural
let g:dbext_table_names_case = 2 
    # 0 - disabled, 1 - camelcase, 2 - underscore</code></pre>

<p>Also there is an option to automatically strip <code>_id</code> suffix from word to convert it to table name:</p>

<pre><code>let g:dbext_table_names_strip_id = 1</code></pre>

<p>All these options match Rails table name convention by default. Staff in <a href='http://github.com/bogdan/dbext'>my dbext fork</a>.</p>

<p>Once you install it in your vim runtime put your cursor on any table name variation like example above and run <code>:DBSelectFromTable</code> to get:</p>

<p><code>select * from user_roles</code></p>

<p>Other commands are also patched. Please let me know if any bugs found.</p>

<p>Don&#8217;t know if non-rails developers would love this patch but pretty sure that it won&#8217;t annoy them. Please support <a href='https://github.com/zklinger/dbext/pull/1'>my pull request</a> if you like it.</p>-->
        <h4 class="tags">
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/vim.html">vim</a>
    
    <a href="/tags/dbext.html">dbext</a>
    
    <a href="/tags/patch.html">patch</a>
    
    <a href="/tags/convention.html">convention</a>
    
    <a href="/tags/sql.html">sql</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2011/05/http-api-logging-rails'>Logging HTTP api calls just like database queries</a>
            <div class="date">24 May 2011</div>
        </h2>
        Http api calls are pretty similar to SQL queries - they query data from external source to process them in ruby space. So I think it's a good idea to log them just like ActiveRecord does with SQL queries. 
<pre><code>  Location Load (25.1ms)   SELECT * FROM "locations" WHERE ("locations"."id" = 2548) ORDER BY title</code></pre>

<!--
This simple peace of code could be very helpful in case of 
<a href="http://github.com/railsware/http_logger">
    debugging HTTP api in ruby</a>.
<a href="https://github.com/railsware/http_logger/blob/master/screenshots/solr.png">Screenshot</a> with the result


Installation is simple:

<pre><code>gem install http_logger</code></pre>

And:

<pre><code>require 'http_logger'

Net::HTTP.logger = Logger.new(...) 
    # Default: Rails.logger if defined?(Rails)

Net::HTTP.colorize = true 
    # Default: true</code></pre>

-->
        <h4 class="tags">
    
    <a href="/tags/api.html">api</a>
    
    <a href="/tags/http.html">http</a>
    
    <a href="/tags/logging.html">logging</a>
    
    <a href="/tags/ruby.html">ruby</a>
    
    <a href="/tags/rails.html">rails</a>
    
    <a href="/tags/debug.html">debug</a>
    
    <a href="/tags/gem.html">gem</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2011/05/migrate-wordpress-jekyll-post-preview'>Finally get rid of WordPress and PHP</a>
            <div class="date">20 May 2011</div>
        </h2>
        <p>After a few tries migrate to blog engine with programming language I know well, I finally found <a href='http://github.com/mojombo/jekyll'>jekyll</a> - lightweight static site generator. My main concerns in this choice was:</p>

<ul>
<li>Edit posts in my favorite text editor with favorite markup</li>

<li>NO PHP</li>

<li>Syntax highlight out of the box</li>
</ul>
<!--
<h3 id='migration_from_wordpress'>Migration from WordPress</h3>

<p>Three main migration points was:</p>

<ul>
<li>Posts that was migrated with <a href='http://google.com/search?q=wordpress%20jekyll%20migrate'>several lines of ruby code</a></li>

<li>Comments that imported to <a href='http://wordpress.org/extend/plugins/disqus-comment-system/'>disqus</a> as jekyll is static site engine so the comments should be hosted somewhere else</li>

<li>Generate <a href='http://www.google.com.ua/search?sourceid=chrome&amp;client=ubuntu&amp;channel=cs&amp;ie=UTF-8&amp;q=jekyll+tag+cloud'>tag cloud and posts by tag pages</a> that also have a lot of workarounds in the web</li>
</ul>

<p>One problem I am currently have is &#8220;post preview&#8221; feature that is currently unsupported in jekyll. My current approach for this looks like this:</p>

<pre><code>post.content | replace_first:&#39;&lt;!--more--&gt;&#39;,&#39;&lt;!--&#39; | append:&#39;--&gt;&#39; </code></pre>

<h3 id='problems'>Problems</h3>

<p>Jekyll looks not very extensible. Some methods are not available in the API. Example: integrate SASS require more pain the ass than it should be. I am planning to fix that in a few days. Another problem I ran into is that github native support don&#8217;t allow you any extension. My suggestion is to generate static content locally with your own code on top of jekyll and upload static content to git repository.</p>

<p>Currently I build site locally from <a href='http://github.com/bogdan/blog'>source code</a> and push static content into <a href='http://github.com/bogdan/bogdan.github.com'>separated repository</a>.</p>

<h3 id='result'>Result</h3>

<p>About 12 hours of work to transfer 30 posts and their comments. Reworked site design to be more clean.</p>-->
        <h4 class="tags">
    
    <a href="/tags/jekyll.html">jekyll</a>
    
    <a href="/tags/wordpress.html">wordpress</a>
    
    <a href="/tags/php.html">php</a>
    
    <a href="/tags/migration.html">migration</a>
    
    <a href="/tags/liquid.html">liquid</a>
    
    <a href="/tags/criticism.html">criticism</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2011/04/javascript-injection-in-json-inserted-directly-into-script-tag'>JavaScript injection in JSON inserted directly into script tag</a>
            <div class="date">06 Apr 2011</div>
        </h2>
        Pass data from backend to javascript is done in many different ways. One of the most simple is to inject(&lt;%= %&gt;) value as function argument inside of script tag. Unfortunately this pattern has well known XSS vulnerability but in a little different form than same injection in html template.
<!--
<pre><code>&lt;script type="text/javascript"&gt;
    App.initizalizeSomething(<%= data.to_json %>)
&lt;/script&gt;</code></pre>

The reason is that browser treat <strong>&lt;/script&gt;</strong> as close script tag no matter where is it inserted into script. So, the script tag can be closed unexpectedly and opened again with any code if the <em>data</em> argument will contain correctly formed sequence, like:
<pre><code>&lt;/script&gt;&lt;script&gt;alert('hello')&lt;/script&gt;</code></pre>

Use <em>#html_escape</em> helper is wrong here because it has different type of escaping.
For example you don't need to escape double quote in this case.

Rails core team is aware of that problem and implemented special helper:
<pre><code># A utility method for escaping HTML entities in JSON strings
# using \uXXXX JavaScript escape sequences for string literals:
#
#   json_escape('is a &gt; 0 &amp; a < 10?')
#   # => is a \u003E 0 \u0026 a \u003C 10?
#
# Note that after this operation is performed the output is not
# valid JSON. In particular double quotes are removed:
#
#   json_escape('{&quot;name&quot;:&quot;john&quot;,&quot;created_at&quot;:&quot;2010-04-28T01:39:31Z&quot;,&quot;id&quot;:1}')
#   # => {name:john,created_at:2010-04-28T01:39:31Z,id:1}
#
# This method is also aliased as +j+, and available as a helper
# in Rails templates:
#
#   <%=j @person.to_json %>
#
def json_escape(s)</code></pre>
Implementation can be found in <a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/core_ext/string/output_safety.rb#L53" target="_blank">Rails source code</a>. 
-->
        <h4 class="tags">
    
    <a href="/tags/javascript.html">javascript</a>
    
    <a href="/tags/html.html">html</a>
    
    <a href="/tags/xss.html">xss</a>
    
    <a href="/tags/escape.html">escape</a>
    
    <a href="/tags/json.html">json</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2011/03/do-git-commits-associated-to-hoptoad-errors'>Do git commits associated to hoptoad errors</a>
            <div class="date">28 Mar 2011</div>
        </h2>
        We are trying to build a better development workflow by connecting all our tools together.
So, this time we tried to connect HopToad Application with git commits because sometimes it's better to just paste the link to hoptoad error rather than describe all steps to reproduce. This idea was resulted in the command line interface for hoptoad api with a little git integration - <a target="_blank" href="http://github.com/railsware/shelltoad">Shelltoad</a>.
<!--
<br/><br/>
Currently, in order to resolve hoptoad error we do the following.<br/>
Check the list of errors:
<pre><code>$ shelltoad
[#3374331] production ActionController::MethodNotAllowed: Only put requests are allowed
[#4023713] production ActiveRecord::StatementInvalid: PGError: ERROR:
       duplicate key value violates unique constraint "index_companies_on_slug" :
       INSERT INTO "companies" .....
</code></pre>
View the information on the required error.
 '713' is automatically guess for 4023713
<pre><code>
$ shelltoad 713
ActiveRecord::StatementInvalid: PGError: ERROR: duplicate key value violates unique constraint
 "index_companies_on_slug" : INSERT INTO "companies"
("slug", "created_at", "title", "updated_at", "external_url", "logo_id", "custom") VALUES('abbott-associates
/var/data/www/apps/startwire/shared/bundle/ruby/1.8/gems/activerecord-
2.3.8/lib/active_record/connection_adapters/abstract_adapter.rb:221
/var/data/www/apps/startwire/releases/20110218113457/app/models/company.rb:50
/var/data/www/apps/startwire/releases/20110218113457/app/utils/network_map/populate.rb:9
/var/data/www/apps/startwire/releases/20110218113457/app/utils/network_map/populate.rb:74
/var/data/www/apps/startwire/releases/20110218113457/app/utils/network_map/populate.rb:70
....
</code></pre>
Fix the error in the code ...
Prepare git commit:
<pre><code>
$ git add .
</code></pre>
Commit the fix to git with connection to hoptoad issue id
<pre><code>
$ shelltoad commit 713
[dev 47f09ec]     http://xxx.hoptoadapp.com//errors/4023713
 1 files changed, 1 insertions(+), 1 deletions(-)
</code></pre>

Commit message will look like this:
<code><pre>http://startdatelabs.hoptoadapp.com//errors/4023713

ActiveRecord::StatementInvalid: PGError: ERROR: duplicate key value violates unique constraint
 "index_companies_on_slug" : INSERT INTO "companies"
("slug", "created_at", "title", "updated_at", "external_url", "logo_id", "custom") VALUES('abbott-associates</pre></code>


This help us maintain the links between git and hoptoad automatically.
-->
        <h4 class="tags">
    
    <a href="/tags/ruby.html">ruby</a>
    
    <a href="/tags/git.html">git</a>
    
    <a href="/tags/hoptoad.html">hoptoad</a>
    
    <a href="/tags/commit.html">commit</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2011/03/ajax-jquery-debug-javascript'>Debug ajax requests in more easy way</a>
            <div class="date">18 Mar 2011</div>
        </h2>
        When I have to debug ajax requests, I always feel pain in the ass accessing the exception message and backtrace. It require at least 3 clicks to get them and only in the plain html format, that web framework use to generate. Is it better to see it at once in the browser popup?  
<!--
<br/><br/>
This can be done with Ajax callbacks offered by javascript framework(if yours doesn't - get rid of it). We can catch errors there and display popup. JQuery example with #ajaxError callback that fires on every unsuccessful ajax call:
<pre><code>(function() {
      var popup = null;
      $(document).ajaxError(function(event, xhr, settings, exception) {
        if (popup) {
          popup.close();
          popup = null;
        }
        popup = window.open(null, "error", "width=800,height=600");
        $(popup.document.documentElement).html(xhr.responseText);
        return true;
      });
    }());</code></pre>

Checked in FF and Chrome(IE is not a browser).
<a href="http://img6.imagebanana.com/img/drl8wpd9/screenshot_014.png">Screenshot</a> with the result. Be aware of browser popup blocker. <br/>
You always have a control when popup the error. I like it to be "in any case". But You can customize it with <em>xhr.status</em> and <em>if</em> statement on the server side.
<br/><br/>
In some cases it might be useful not only in the development but in production as well. But it should be an iframe inside of pretty html layout, so that designers won't blame programmers too much.
-->
        <h4 class="tags">
    
    <a href="/tags/javascript.html">javascript</a>
    
    <a href="/tags/jquery.html">jquery</a>
    
    <a href="/tags/debug.html">debug</a>
    
    <a href="/tags/ajax.html">ajax</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2010/11/dynamic-context-in-rspec-dont-repeat-yourself'>Dynamic context in Rspec - don't repeat yourself</a>
            <div class="date">03 Nov 2010</div>
        </h2>
        We used to have less problems with subject and behavior when writing our unit tests. And <strong>context</strong> is what testing is all about.
 Web apps manage data and the same method can return different values based on current database state.
Advanced rspec features make it possible to use very effective technique to organize tests. 
In order to reflect your non-linear business process in unit tests you can not only nest contexts in each other but also make your context more dynamic.
<!--

<h3>Context callback</h3>
Rspec <code>#let</code> method is used to lazy load things into context.
In spite of lazy initialization, let blocks are defined before the <code>before each</code> hook. 
This allow us to create context callback.
<br/><br/>
Understand by example. 
In this example orders should be delivered to confirmed customer account just after creation and should not be delivered if the account is not confirmed yet.
<pre><code>describe Order do
  context "after create" do #defining a partial context
    before(:each) do
      subject.customer.confirmed = _confirmed
      subject.save!
    end

    context "when customer is confirmed" do 
      let(:_confirmed) { true }
      it { should be_delivered }
    end
    
    context "when customer is not confirmed" do 
      let(:_confirmed) { false }
      it { should_not be_delivered }
    end
  end
end</code></pre>

Here you can see partial context definition and custom behavior in two nested contexts.
I used underscore prefix in order to identify the callback method, that is defined differently in different contexts.<br/> <br/>
This happened because <code>let</code> as method is defined at once but <code>before</code> block is called only when <code>it</code> is reached.

<h3>Testing utility function</h3>
Another example that is a kind of pattern matching(Erlang term), designed to test utility functions.<br/>
Suppose we have a boolean expression evaluation function:
<pre><code>describe Expression
  describe ".run" do

    subject { Expression.run(arg) }

    context "with '&amp;' where both true" do
      let(:arg) { "true &amp; true" }
      it {should be_true}
    end

    context "with '&amp;' where one false" do
      let(:arg) { "false &amp; true" }
      it {should be_false}
    end
    ........
  end
end</code></pre>

Very good strategy to run same function with different arguments.

<h3>Summary</h3>

Rspec is far ahead of all unit testing frameworks. Unlike most of Rspec clones (e.g. for other programming languages), Rspec authors got in deep to the testing problems and invent flexible and elegant syntax.
-->
        <h4 class="tags">
    
    <a href="/tags/behavior.html">behavior</a>
    
    <a href="/tags/rspec.html">rspec</a>
    
    <a href="/tags/context.html">context</a>
    
    <a href="/tags/test.html">test</a>
    
    <a href="/tags/dry.html">dry</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2010/09/good-passwords-theory'>Good passwords theory</a>
            <div class="date">30 Sep 2010</div>
        </h2>
        All of us are using passwords and most of us are typing them several times a day. And everyone knows the criteria to generate a good password. Random passwords are very strong from protection point of view but not from usability point of view. 
No body think about password unforgettable-ness and less-painful-to-type-ness. I saw many passwords that are very painful because they are just random. 

And I think it's nice to lose some randomness and make it easier to type and remember.
There is still a lot of enough strong passwords that match this criteria as well. 
<!--
<br/>
Try to type and remember something like:
<pre><code>sudosuamigo1;
s3host-large
you&me2gether</code></pre>
Instead of:
<pre><code>1aWhuyZ
!nzu?Us0
n]1m!uaA</code></pre>
 
And you feel much better.
-->
        <h4 class="tags">
    
    <a href="/tags/usability.html">usability</a>
    
    <a href="/tags/password.html">password</a>
    
    <a href="/tags/security.html">security</a>
    
    <a href="/tags/random.html">random</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2010/08/populate-db-pattern-fake-data'>Populate database pattern - why is it so cool?</a>
            <div class="date">26 Aug 2010</div>
        </h2>
        Once my co-worker propose an idea to fill database with some fake data because we didn't have a  gui forms yet and we have to show something that works to customer. That was a start for great pattern - <strong>populator</strong>.
<!--

<h3>Advantages</h3>
Later we didn't drop that functionality because it was helpful for everyone to always see what's new appear in application. And we find more and more useful aspects of having populator. It was so easy to attach new people to project because we deliver a short set of data within a source code that demonstrates everything we have in our app. Now whole team has a full data set and see if any page doesn't work because of a side effect. Frontend people feel more comfortable with populator because they don't care of how to create many assets in order to see pagination and things like that . Also UI issues became easier to detect because every element present on a screen for every person letting him detect browser specific bugs. 

<h3> Implementation</h3>

I won't recommend any specific library to populate the db except the one to generate fake(Lorem ipsum) content. We prefer <a href="http://github.com/stympy/faker">Faker</a> but that is up to personal choice.
Important note is that inserting data directly into db is bad idea because all application logic is ignored in this case: validation will be ignored and counters cache might be broken. That is why Populate gem is not recommended.<br/><br/>
One nice improvement we made is pass _SCALE_ parameter to populator in order to control how many objects should be generated. Use minimal amount if you need to test that populator works and regular amount to get working system.<br/>
Another good idea is soft save(ignore if not valid) and output the number of created objects after at the end. This letting you if something went wrong during populate process.<br/>
<br/>
Here is an example of how it may look like:
<pre><code>User.transaction do
  # apply the SCALE parameter to the argument. 
  # Default SCALE is 10 so 10 * 1 = 10. 
  # Generate 10 users by default
  scale(1).times do 
    user = User.new
    user.email = Faker::Internet.email
    user.first_name = Faker::Name.first_name
    user.last_name = Faker::Name.last_name
    user.password = user.password_confirmation = 'monkey'
    user.save # this may be false in case of uniqueness restriction or other problems
  end
end


users = User.all
puts "Users: #{users.count}" # make sure we actually made some users </code></pre>

<h3>At the end</h3>
I beleive that Populator should be a part of the build of every project. Yes, it needs some support but in fact it saves lots and lots of time.
-->
        <h4 class="tags">
    
    <a href="/tags/database.html">database</a>
    
    <a href="/tags/ruby.html">ruby</a>
    
    <a href="/tags/pattern.html">pattern</a>
    
    <a href="/tags/populate.html">populate</a>
    
    <a href="/tags/fake.html">fake</a>
    
    <a href="/tags/data.html">data</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>

    <div class="post">
        <h2>
            <a href='/2010/07/bdd-rspec-matcher-to-test-named_scope-scoped-rails-3'>Ultimate rspec matcher to test named_scope or scoped</a>
            <div class="date">11 Jul 2010</div>
        </h2>
        After having a good practice on using <a href="http://gusiev.com/2010/06/ultimate-rspec-matcher-to-test-validation/">Ultimate rspec matcher to test validation</a> I think it's time to implement one for testing named scopes - custom finders. Testing these finders is daily task. Here is how it can be done with minimum amount of code and maximum readability.
<!--
<h3>Discovery <del>(Animal Planet)</del></h3>

What do we expect from the custom finder?
We expect that it should find assets A, B, C and should not find assets D, E, F.
And sometimes the order is important: it should find A, B C with exact order.

With respect to <em>let</em> rspec feature let's take an example: Product has and belongs to many categories. We need to have a scope to filter products within the specified category:

<pre><code>describe "#by_category_id" do
      let(:given_category) do 
        Factory.create(:given_category)
      end
 

      let(:product_in_given_category) do
        Factory.create(
          :product,
          :categories => [category]
        )
      end

      let(:product_not_in_given_category) do
        Factory.create(
          :product,
          :categories => [Factory.create(:category)]
        )
      end

      # This might be tricky to redefine subject as the finder result
      # but in this way we can delegate the matcher to subject and 
      # avoid writing test descriptions.
      subject { Product.by_category_id(given_category.id) }

      it { should discover(product_in_given_category) }
      it { should_not discover(product_not_in_given_category) }

    end
</code></pre> 

Factory girl was used in this example because factories kickass when we test finders. As you can see the example has a perfect readability with no one line of plain English text. I didn't include the description in my examples but you can easily make them if they make sense for you.<br/>
Note: Be aware of the lazy loading of your finder. <em>let</em> is initialized lazy too. You should make sure it is called before the actual query to the database.
If you don't want to care about lazy loading their is <em>let!</em> method that could be easily copy-pasted from Rspec 2.0. Unlike <em>let</em> it doesn't have lazy initialization:
<pre><code>def let!(name, &block)
  let(name, &block)
  before { __send__(name) } 
end
</code></pre>

<h3>Testing sort order</h3>

If the ordering is done in non-trivial way let's <em>discover.with_exact_order</em>. 
<pre><code>describe "#most_commented named scope" do
  let(:uncommented_post) { Factory.create(:post)}
  let!(:less_commented_post) { Factory.create(:post, :comments => [Factory.build(:comment)])}
  let!(:more_commented_post) { 
    Factory.create(:post, :comments => [Factory.build(:comment), Factory.build(:comment)])}
  }

  subject { described_class.most_commented }
 it {should discover(more_commented_post, less_commented_post).with_exact_order }
 it {should_not discover(uncommented_post) }
end</code></pre>

Be careful with default order. MySQL and Postgres sort objects as they were created by default.
That is why generate objects in reverse order e.g. <em>less_commented_post</em> before <em>more_commented_post</em> is important to make sure that ordering is your code behavior rather than default db behavior.
 
<h3> Summary </h3>
I 've add this matcher to the <a href="http://gusiev.com/2010/06/ultimate-rspec-matcher-to-test-validation/">previous one</a>. Both matchers are available here <a href="http://github.com/bogdan/accept_values_for">accept_values_for</a>. Let's start thinking of what else we can do.
-->
        <h4 class="tags">
    
    <a href="/tags/bdd.html">bdd</a>
    
    <a href="/tags/rspec.html">rspec</a>
    
    <a href="/tags/activerecord.html">activerecord</a>
    
    <a href="/tags/named_scope.html">named_scope</a>
    
    <a href="/tags/matcher.html">matcher</a>
    
    
</h4>
<div class="clear"></div>

        <hr/>
    </div>


<div class='paginator'>
    
        <div class='next'>
            <a href='/page4'>
                Earlier posts &rarr;
            </a>
        </div>
    
    
        <div class='prev'>
            
                <a href='/'>
                    &larr; Later posts
                </a>
            
        </div>
    
    <div class='clear'></div>
</div>

                </div>
                <div class="vsplit">
                </div>
                <div id="sidebar">
                    <div class="recent-posts">
                        <h2>Recent Posts</h2>
                        <a class="rss" href="http://feeds.feedburner.com/BogdanGusiev">
                            <img src="/images/rss.png" alt="Bogdan Gusiev&#8217;s blog" />
                        </a>
                        <div class="clear"></div>
                        <ul>
                            
                            <li>
                                <a href='/2013/11/datagrid-slides-report-framework'>Datagrid slides from Ruby Meditation 3</a>
                            </li>
                            
                            <li>
                                <a href='/2013/05/rails-ajax-validation-form-submit-javascript'>Support validation through ajax in Rails 4.x</a>
                            </li>
                            
                            <li>
                                <a href='/2013/04/git-story-id-pivotal-tracker-integration'>Attach git commits to pivotal stories</a>
                            </li>
                            
                            <li>
                                <a href='/2013/04/background-jobs-frameworkds-delayed-job-resque-slides'>Background Jobs Frameworks: Resque vs DelayedJob</a>
                            </li>
                            
                            <li>
                                <a href='/2013/02/working-in-curebit-ycombinator-ukraine-job'>Where to work as a rubyist in Ukraine</a>
                            </li>
                            
                        </ul>
                    </div>
                    <div class="slides">
                      <h2>Presentations</h2>
                      <ul>
                        <li>
                          <a href='/dorspec#1'>Fogotten Features of RSpec</a>
                        </li>
                        <li>
                          <a href='/slides/rails_contribution/static/#1'>Power Hacking Rails internals</a>
                        </li>
                        <li>
                          <a href='/slides/fighting_fat_models/static'>Fighting Fat Models</a>
                        </li>
                        <li>
                          <a href='/slides/background-jobs-frameworks/static/#1'>Background job Frameworks</a>
                        </li>
                      </ul>
                    </div>
                    <div class="sidebarbox">
                        <h2>Search</h2>
                        <form method="get" id="searchform" action="">
    <input type="text" placeholder="Search keywords" name="s" id="searchbox"/>
    <input type="submit" class="submitbutton" value="Find" />
</form>
<script>
    $('#searchform').submit(function(event) {
    event.preventDefault();
    window.location.href = "http://google.com/search?q=site:gusiev.com " + $('#searchbox').val();
    });
</script>

                    </div>
                    <div class="sidebarbox tag-cloud">
                        <h2>Browse by tags</h2>
                        <a href="/tags/activerecord.html" title="Pages tagged activerecord" style="font-size: 23.0px; line-height:23.0px" rel="tag">activerecord</a> 
<a href="/tags/ajax.html" title="Pages tagged ajax" style="font-size: 21.2px; line-height:21.2px" rel="tag">ajax</a> 
<a href="/tags/api.html" title="Pages tagged api" style="font-size: 17.6px; line-height:17.6px" rel="tag">api</a> 
<a href="/tags/application.html" title="Pages tagged application" style="font-size: 17.6px; line-height:17.6px" rel="tag">application</a> 
<a href="/tags/bdd.html" title="Pages tagged bdd" style="font-size: 17.6px; line-height:17.6px" rel="tag">bdd</a> 
<a href="/tags/behavior.html" title="Pages tagged behavior" style="font-size: 19.4px; line-height:19.4px" rel="tag">behavior</a> 
<a href="/tags/changelog.html" title="Pages tagged changelog" style="font-size: 17.6px; line-height:17.6px" rel="tag">changelog</a> 
<a href="/tags/class.html" title="Pages tagged class" style="font-size: 17.6px; line-height:17.6px" rel="tag">class</a> 
<a href="/tags/commit.html" title="Pages tagged commit" style="font-size: 17.6px; line-height:17.6px" rel="tag">commit</a> 
<a href="/tags/context.html" title="Pages tagged context" style="font-size: 17.6px; line-height:17.6px" rel="tag">context</a> 
<a href="/tags/contribution.html" title="Pages tagged contribution" style="font-size: 24.8px; line-height:24.8px" rel="tag">contribution</a> 
<a href="/tags/criticism.html" title="Pages tagged criticism" style="font-size: 24.8px; line-height:24.8px" rel="tag">criticism</a> 
<a href="/tags/database.html" title="Pages tagged database" style="font-size: 19.4px; line-height:19.4px" rel="tag">database</a> 
<a href="/tags/datagrid.html" title="Pages tagged datagrid" style="font-size: 19.4px; line-height:19.4px" rel="tag">datagrid</a> 
<a href="/tags/debug.html" title="Pages tagged debug" style="font-size: 19.4px; line-height:19.4px" rel="tag">debug</a> 
<a href="/tags/dry.html" title="Pages tagged dry" style="font-size: 19.4px; line-height:19.4px" rel="tag">dry</a> 
<a href="/tags/gem.html" title="Pages tagged gem" style="font-size: 24.8px; line-height:24.8px" rel="tag">gem</a> 
<a href="/tags/git.html" title="Pages tagged git" style="font-size: 17.6px; line-height:17.6px" rel="tag">git</a> 
<a href="/tags/howto.html" title="Pages tagged howto" style="font-size: 21.2px; line-height:21.2px" rel="tag">howto</a> 
<a href="/tags/html.html" title="Pages tagged html" style="font-size: 21.2px; line-height:21.2px" rel="tag">html</a> 
<a href="/tags/idea.html" title="Pages tagged idea" style="font-size: 17.6px; line-height:17.6px" rel="tag">idea</a> 
<a href="/tags/java.html" title="Pages tagged java" style="font-size: 21.2px; line-height:21.2px" rel="tag">java</a> 
<a href="/tags/javascript.html" title="Pages tagged javascript" style="font-size: 28.4px; line-height:28.4px" rel="tag">javascript</a> 
<a href="/tags/jquery.html" title="Pages tagged jquery" style="font-size: 17.6px; line-height:17.6px" rel="tag">jquery</a> 
<a href="/tags/patch.html" title="Pages tagged patch" style="font-size: 17.6px; line-height:17.6px" rel="tag">patch</a> 
<a href="/tags/pattern.html" title="Pages tagged pattern" style="font-size: 17.6px; line-height:17.6px" rel="tag">pattern</a> 
<a href="/tags/performance.html" title="Pages tagged performance" style="font-size: 19.4px; line-height:19.4px" rel="tag">performance</a> 
<a href="/tags/programming.html" title="Pages tagged programming" style="font-size: 21.2px; line-height:21.2px" rel="tag">programming</a> 
<a href="/tags/query.html" title="Pages tagged query" style="font-size: 17.6px; line-height:17.6px" rel="tag">query</a> 
<a href="/tags/rails.html" title="Pages tagged rails" style="font-size: 37.400000000000006px; line-height:37.400000000000006px" rel="tag">rails</a> 
<a href="/tags/report.html" title="Pages tagged report" style="font-size: 17.6px; line-height:17.6px" rel="tag">report</a> 
<a href="/tags/resque.html" title="Pages tagged resque" style="font-size: 17.6px; line-height:17.6px" rel="tag">resque</a> 
<a href="/tags/rspec.html" title="Pages tagged rspec" style="font-size: 23.0px; line-height:23.0px" rel="tag">rspec</a> 
<a href="/tags/ruby.html" title="Pages tagged ruby" style="font-size: 28.4px; line-height:28.4px" rel="tag">ruby</a> 
<a href="/tags/service.html" title="Pages tagged service" style="font-size: 19.4px; line-height:19.4px" rel="tag">service</a> 
<a href="/tags/slides.html" title="Pages tagged slides" style="font-size: 23.0px; line-height:23.0px" rel="tag">slides</a> 
<a href="/tags/sql.html" title="Pages tagged sql" style="font-size: 19.4px; line-height:19.4px" rel="tag">sql</a> 
<a href="/tags/test.html" title="Pages tagged test" style="font-size: 19.4px; line-height:19.4px" rel="tag">test</a> 
<a href="/tags/usability.html" title="Pages tagged usability" style="font-size: 17.6px; line-height:17.6px" rel="tag">usability</a> 
<a href="/tags/validation.html" title="Pages tagged validation" style="font-size: 21.2px; line-height:21.2px" rel="tag">validation</a> 
<a href="/tags/vim.html" title="Pages tagged vim" style="font-size: 17.6px; line-height:17.6px" rel="tag">vim</a> 

                    </div>
                </div><!-- Closes Sidebar_full -->
                <div class="clear"></div>
            </div> <!-- Closes Sidebar -->
            <div class="clear"></div>

        </div><!-- Closes Main -->


        <div class="footer">
            <hr/>
            <!--LiveInternet counter-->

            <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                document.write("<a href='http://www.liveinternet.ru/click' "+
                        "target=_blank><img src='http://counter.yadro.ru/hit?t40.6;r"+
                        escape(document.referrer)+((typeof(screen)=="undefined")?"":
                            ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
                                screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
                        ";"+Math.random()+
                        "' alt='' title='LiveInternet' "+
                        "border='0' width='31' height='31'><\/a>");
                }
                </script><!--/LiveInternet-->
                <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
                    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
                }
                    </script>
                    <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                        try {
                            var pageTracker = _gat._getTracker("UA-12663165-1");
                            pageTracker._trackPageview();
                        } catch(err) {}
                }</script>

            <div style="text-align: center; padding-right: 350px">
                The Content of this blog can be published anywhere with the link to original source.
            </div>
        </div><!-- Closes morefoot -->




    </body>
</html>



