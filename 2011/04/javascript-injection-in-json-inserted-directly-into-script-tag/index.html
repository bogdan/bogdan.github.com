<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>

    <title>Bogdan Gusiev's blog</title>
    <meta name="robots" content="follow, all" />
    <meta name="description" content="This is personal blog of Bogdan Gusiev: ruby on rails developer, open source contributor">
    <meta name="keywords" content="activerecord, api, application, bdd, behavior, context, criticism, database, debug, dry, gem, howto, html, idea, java, javascript, named_scope, pattern, programming, query, rails, rspec, ruby, sql, test, usability, vim" />
    <link rel="stylesheet" href="/css/default.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/highlight.css" type="text/css" media="screen" />
    <link rel="alternate" type="application/rss+xml" title="Bogdan Gusiev's blog RSS Feed" href="http://feeds.feedburner.com/BogdanGusiev" />
    <link rel="shortcut icon" href="/images/favicon.ico"/>
    <link rel="icon" href="/images/favicon.ico"/>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
        <script>
            $(document).ready(function() {
                var params = decodeURI(window.location.search).replace(/^\?/, "").split("&");
                $(params).each(function(index, param) {
                    if (param.match(/^p=/)) {

                        switch(parseInt(param.split("=")[1])) {
                            case 11: window.location.href = "http://www.gusiev.com/2009/04/clear-upload-file-input-field/";
                            break;
                            case 3: window.location.href = "http://www.gusiev.com/2009/04/upload-files-with-selenium-ide/";
                            break;
                        }
                    }
                })
            });
        </script>
    </head>

    <body>
        <a href="http://github.com/bogdan" class="fork">
            <img src="/images/fork.png"/>
        </a>

        <div id="wrapper">

            <div class="header">
                <div class="title">
                    <h1><a href="/">Bogdan Gusiev's blog</a></h1>
                    <h4>How to make your Ruby on Rails application</h4>
                </div>

                <div class="pages">
                    <a href="/">Home</a>
                    <a href="/pages/about.html">About me</a>
                    <a href="/pages/contacts.html">Contacts</a>
                </div>
                <a href="/pages/about.html" class="avatar">
                    <img src="/images/me.jpg"/>
                </a>
                <div class="clear"></div>
                <hr/>
            </div> <!-- Closes header -->


            <div id="main">

                <div id="content">
                    <div id="post">
    <h2>
        <a href="/2011/04/javascript-injection-in-json-inserted-directly-into-script-tag">JavaScript injection in JSON inserted directly into script tag</a>
        <div class="date">06 Apr 2011</div>
    </h2>
    Pass data from backend to javascript is done in many different ways. One of the most simple is to inject(&lt;%= %&gt;) value as function argument inside of script tag. Unfortunately this pattern has well known XSS vulnerability but in a little different form than same injection in html template.
<!--more-->
<pre><code>&lt;script type="text/javascript"&gt;
    App.initizalizeSomething(<%= data.to_json %>)
&lt;/script&gt;</code></pre>

The reason is that browser treat <strong>&lt;/script&gt;</strong> as close script tag no matter where is it inserted into script. So, the script tag can be closed unexpectedly and opened again with any code if the <em>data</em> argument will contain correctly formed sequence, like:
<pre><code>&lt;/script&gt;&lt;script&gt;alert('hello')&lt;/script&gt;</code></pre>

Use <em>#html_escape</em> helper is wrong here because it has different type of escaping.
For example you don't need to escape double quote in this case.

Rails core team is aware of that problem and implemented special helper:
<pre><code># A utility method for escaping HTML entities in JSON strings
# using \uXXXX JavaScript escape sequences for string literals:
#
#   json_escape('is a &gt; 0 &amp; a < 10?')
#   # => is a \u003E 0 \u0026 a \u003C 10?
#
# Note that after this operation is performed the output is not
# valid JSON. In particular double quotes are removed:
#
#   json_escape('{&quot;name&quot;:&quot;john&quot;,&quot;created_at&quot;:&quot;2010-04-28T01:39:31Z&quot;,&quot;id&quot;:1}')
#   # => {name:john,created_at:2010-04-28T01:39:31Z,id:1}
#
# This method is also aliased as +j+, and available as a helper
# in Rails templates:
#
#   <%=j @person.to_json %>
#
def json_escape(s)</code></pre>
Implementation can be found in <a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/core_ext/string/output_safety.rb#L53" target="_blank">Rails source code</a>. 

    <h4 class="tags">
    
    
    <a href="/tags/javascript.html">javascript</a>
    
    <a href="/tags/html.html">html</a>
    
    <a href="/tags/xss.html">xss</a>
    
    <a href="/tags/escape.html">escape</a>
    
    <a href="/tags/json.html">json</a>
    
</h4>
<div class="clear"></div>


    <div id="related">
        <h3>Related Posts</h3>
        <ul class="posts">
            
            <li><span>23 Apr 2009</span> &raquo; <a href="/2009/04/clear-upload-file-input-field">Clear upload file input field </a></li>
            
            <li><span>08 Jun 2010</span> &raquo; <a href="/2010/06/nesting-namespace-route-non-flat-controllers-hierarchy-rails">Advanced non-flat controllers hierarchy with rails</a></li>
            
            <li><span>05 Apr 2010</span> &raquo; <a href="/2010/04/ruby18-private-protected-incapsulatio">Encapsulation in Ruby: 'private' doesn't give expected level of privacy</a></li>
            
        </ul>
    </div>

    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'gusiev'; // required: replace example with your forum shortname

    //var disqus_identifier = '/2011/04/javascript-injection-in-json-inserted-directly-into-script-tag';
    //var disqus_url = 'http://gusiev.com/2011/04/javascript-injection-in-json-inserted-directly-into-script-tag';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
</div>


                </div>
                <div class="vsplit">
                </div>
                <div id="sidebar">
                    <div class="recent-posts">
                        <h2>Recent Posts</h2>
                        <a class="rss" href="http://feeds.feedburner.com/BogdanGusiev">
                            <img src="/images/rss.png" alt="Bogdan Gusiev&#8217;s blog" />
                        </a>
                        <div class="clear"></div>
                        <ul>
                            
                            <li>
                                <a href='/2011/10/resque-plugins-framework-scaling'>Resque-way</a>
                            </li>
                            
                            <li>
                                <a href='/2011/07/rspec-context-behavior-subject-slides'>Advanced RSpec Techniques presentation</a>
                            </li>
                            
                            <li>
                                <a href='/2011/06/ruby-datagrid-gem-report'>Reporting made easy by Datagrid gem for Rails</a>
                            </li>
                            
                            <li>
                                <a href='/2011/05/dbext-vim-table-names-convention-patch'>Patching dbext vim plugin to support Rails naming conventions</a>
                            </li>
                            
                            <li>
                                <a href='/2011/05/http-api-logging-rails'>Logging HTTP api calls just like database queries</a>
                            </li>
                            
                        </ul>
                    </div>
                    <div class="sidebarbox">
                        <h2>Search</h2>
                        <form method="get" id="searchform" action="">
    <input type="text" placeholder="Search keywords" name="s" id="searchbox"/>
    <input type="submit" class="submitbutton" value="Find" />
</form>
<script>
    $('#searchform').submit(function(event) {
    event.preventDefault();
    window.location.href = "http://google.com/search?q=site:gusiev.com " + $('#searchbox').val();
    });
</script>

                    </div>
                    <div class="sidebarbox tag-cloud">
                        <h2>Browse by tags</h2>
                        <a href="/tags/activerecord.html" title="Pages tagged activerecord" style="font-size: 21.2px; line-height:21.2px" rel="tag">activerecord</a> 
<a href="/tags/api.html" title="Pages tagged api" style="font-size: 17.6px; line-height:17.6px" rel="tag">api</a> 
<a href="/tags/application.html" title="Pages tagged application" style="font-size: 17.6px; line-height:17.6px" rel="tag">application</a> 
<a href="/tags/bdd.html" title="Pages tagged bdd" style="font-size: 17.6px; line-height:17.6px" rel="tag">bdd</a> 
<a href="/tags/behavior.html" title="Pages tagged behavior" style="font-size: 19.4px; line-height:19.4px" rel="tag">behavior</a> 
<a href="/tags/context.html" title="Pages tagged context" style="font-size: 17.6px; line-height:17.6px" rel="tag">context</a> 
<a href="/tags/criticism.html" title="Pages tagged criticism" style="font-size: 24.8px; line-height:24.8px" rel="tag">criticism</a> 
<a href="/tags/database.html" title="Pages tagged database" style="font-size: 19.4px; line-height:19.4px" rel="tag">database</a> 
<a href="/tags/debug.html" title="Pages tagged debug" style="font-size: 17.6px; line-height:17.6px" rel="tag">debug</a> 
<a href="/tags/dry.html" title="Pages tagged dry" style="font-size: 17.6px; line-height:17.6px" rel="tag">dry</a> 
<a href="/tags/gem.html" title="Pages tagged gem" style="font-size: 17.6px; line-height:17.6px" rel="tag">gem</a> 
<a href="/tags/howto.html" title="Pages tagged howto" style="font-size: 21.2px; line-height:21.2px" rel="tag">howto</a> 
<a href="/tags/html.html" title="Pages tagged html" style="font-size: 19.4px; line-height:19.4px" rel="tag">html</a> 
<a href="/tags/idea.html" title="Pages tagged idea" style="font-size: 17.6px; line-height:17.6px" rel="tag">idea</a> 
<a href="/tags/java.html" title="Pages tagged java" style="font-size: 21.2px; line-height:21.2px" rel="tag">java</a> 
<a href="/tags/javascript.html" title="Pages tagged javascript" style="font-size: 21.2px; line-height:21.2px" rel="tag">javascript</a> 
<a href="/tags/named_scope.html" title="Pages tagged named_scope" style="font-size: 17.6px; line-height:17.6px" rel="tag">named_scope</a> 
<a href="/tags/pattern.html" title="Pages tagged pattern" style="font-size: 17.6px; line-height:17.6px" rel="tag">pattern</a> 
<a href="/tags/programming.html" title="Pages tagged programming" style="font-size: 21.2px; line-height:21.2px" rel="tag">programming</a> 
<a href="/tags/query.html" title="Pages tagged query" style="font-size: 17.6px; line-height:17.6px" rel="tag">query</a> 
<a href="/tags/rails.html" title="Pages tagged rails" style="font-size: 24.8px; line-height:24.8px" rel="tag">rails</a> 
<a href="/tags/rspec.html" title="Pages tagged rspec" style="font-size: 23.0px; line-height:23.0px" rel="tag">rspec</a> 
<a href="/tags/ruby.html" title="Pages tagged ruby" style="font-size: 26.6px; line-height:26.6px" rel="tag">ruby</a> 
<a href="/tags/sql.html" title="Pages tagged sql" style="font-size: 19.4px; line-height:19.4px" rel="tag">sql</a> 
<a href="/tags/test.html" title="Pages tagged test" style="font-size: 19.4px; line-height:19.4px" rel="tag">test</a> 
<a href="/tags/usability.html" title="Pages tagged usability" style="font-size: 17.6px; line-height:17.6px" rel="tag">usability</a> 
<a href="/tags/vim.html" title="Pages tagged vim" style="font-size: 17.6px; line-height:17.6px" rel="tag">vim</a> 

                    </div>
                </div><!-- Closes Sidebar_full -->
                <div class="clear"></div>
            </div> <!-- Closes Sidebar -->
            <div class="clear"></div>

        </div><!-- Closes Main -->


        <div class="footer">
            <hr/>
            <!--LiveInternet counter-->

            <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                document.write("<a href='http://www.liveinternet.ru/click' "+
                        "target=_blank><img src='http://counter.yadro.ru/hit?t40.6;r"+
                        escape(document.referrer)+((typeof(screen)=="undefined")?"":
                            ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
                                screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
                        ";"+Math.random()+
                        "' alt='' title='LiveInternet' "+
                        "border='0' width='31' height='31'><\/a>");
                }
                </script><!--/LiveInternet-->
                <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
                    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
                }
                    </script>
                    <script type="text/javascript">
                if (window.location.href.indexOf("gusiev") >= 0) {
                        try {
                            var pageTracker = _gat._getTracker("UA-12663165-1");
                            pageTracker._trackPageview();
                        } catch(err) {}
                }</script>

            <div style="text-align: center; padding-right: 350px">
                The Content of this blog can be published anywhere with the link to original source.
            </div>
        </div><!-- Closes morefoot -->




    </body>
</html>



